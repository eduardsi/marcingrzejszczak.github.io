<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[TOO MUCH CODING]]></title>
  <link href="http://toomuchcoding.com/atom.xml" rel="self"/>
  <link href="http://toomuchcoding.com/"/>
  <updated>2016-04-06T22:22:48+02:00</updated>
  <id>http://toomuchcoding.com/</id>
  <author>
    <name><![CDATA[Marcin Grzejszczak]]></name>
    <email><![CDATA[blog@toomuchcoding.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[AccuREST Stub Runner Released]]></title>
    <link href="http://toomuchcoding.com/blog/2016/04/06/accurest-stubrunner-released/"/>
    <updated>2016-04-06T11:05:58+02:00</updated>
    <id>http://toomuchcoding.com/blog/2016/04/06/accurest-stubrunner-released</id>
    <content type="html"><![CDATA[<p>It&rsquo;s been a good release time recently! I&rsquo;m blogging here at <a href="http://toomuchcoding.com">Too Much Coding blog</a> more about releases then about any concrete topics ;)</p>

<p>After releasing <a href="http://toomuchcoding.com/blog/2016/03/25/spring-cloud-sleuth-rc1-deployed/">Spring Cloud Sleuth as a part of Brixton RC1</a> we have just released a version 1.0.4 of <a href="https://github.com/Codearte/accurest">AccuREST</a>. We&rsquo;ve fixed a couple
of bugs but we&rsquo;ve introduced a couple of big features including:</p>

<ul>
<li>Maven plugin support</li>
<li><em>Stub Runner</em> functionality</li>
</ul>


<p>This post will describe the latter feature in more depth.</p>

<!-- more -->


<h2>Introduction</h2>

<p>I&rsquo;ve given quite a few talks about the library called <a href="https://github.com/4finance/micro-infra-spring">Micro-Infra-Spring</a> where I presented how you can profit from the <em>Stub Runner</em> functionality. Since my leaving the company owning that repository, the project is almost not maintained at all. For quite a long time any development was done mostly by me and actually I was the author of most of the <em>Stub Runner&rsquo;s</em> code. Due to the aforementioned and the fact that <em>Stub Runner</em> is tightly coupled with AccuREST&rsquo;s stub generation feature I&rsquo;ve decided to migrate it to the AccuREST&rsquo;s repository.</p>

<h2>AccuREST recap</h2>

<p><em>Stub Runner</em> is tightly coupled with the concepts coming from AccuREST. For more information about AccuREST you can check my <a href="http://toomuchcoding.com/blog/categories/accurest/">blog entries</a> or check <a href="https://github.com/Codearte/accurest">AccuREST project on Github</a>. If you don&rsquo;t have a clue what that is I&rsquo;ll try to do a very fast recap.</p>

<p>AccuREST is a <a href="http://martinfowler.com/articles/consumerDrivenContracts.html">Consumer Driven Contracts</a> verifier in which you define the contract of your API via a Groovy DSL. From that DSL, on the server side, tests are created to check if your contract is telling the truth. From the <em>Stub Runner&rsquo;s</em> perspective more interesting is the client side. For the client side AccuREST generates WireMock stubs from the provided DSL so that the clients of that API can be provided with reliable stubs.</p>

<h2>What is Stub Runner?</h2>

<p>Now that we remember what AccuREST does we can take a look in more depth at <em>Stub Runner</em>. Let&rsquo;s assume that we have a following flow of services (btw. <a href="http://cloud.spring.io/spring-cloud-sleuth/spring-cloud-sleuth.html">this is a screenshot from Zipkin integrated with Spring Cloud Sleuth</a> )</p>

<p><img src="http://toomuchcoding.com/images/accurest/stubrunner/dependencies_accurest.png" alt="Dependencies" /></p>

<p>Let&rsquo;s imagine ourselves as developers of the <em>service2</em> - the one that calls <em>service3</em> and <em>service4</em>. Since we&rsquo;re doing the CDC (<a href="http://martinfowler.com/articles/consumerDrivenContracts.html">Consumer Driven Contracts</a>) approach let&rsquo;s assume that the stubs of <em>service3</em> and <em>service4</em> got already deployed to some Maven repository.</p>

<p>If I&rsquo;m writing integration tests of <em>service2</em> I&rsquo;ll for sure have some points of interaction with <em>service3</em> and <em>service4</em>. Most likely in the majority of cases I&rsquo;ll just mock those interactions in my code but it would be valuable to have a real HTTP call done to the other application. Of course I don&rsquo;t want to download both services and run them only for integration tests - that would be an overkill. That&rsquo;s why the most preferable solution at this point would be to run the stubs of my collaborators.</p>

<p>Since I&rsquo;m too lazy to do things manually I&rsquo;d prefer the stubs to be automatically downloaded for me, the WireMock servers started and fed with the stub definitions.</p>

<p>And that&rsquo;s exactly what <em>Stub Runner</em> can do for you!</p>

<h2>How does it work?</h2>

<h3>Concept</h3>

<p><a href="https://github.com/Codearte/accurest/wiki/8.-Stub-Runner">Stub Runner</a> at its core is using Groovy&rsquo;s Grape mechanism to download the stubs from a given Maven repository. Next it unpacks them to a temporary folder. Let&rsquo;s assume that you have the following structure of your WireMock stubs inside the stub JAR (example for a <code>service3-stubs.jar</code>)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── META-INF
</span><span class='line'>│   └── MANIFEST.MF
</span><span class='line'>└── mappings
</span><span class='line'>    └── service3
</span><span class='line'>        ├── shouldMarkClientAsFraud.json
</span><span class='line'>        ├── notAWireMockMapping.json
</span><span class='line'>        └── shouldSayHello.json</span></code></pre></td></tr></table></div></figure>


<p><em>Stub Runner</em> will scan the whole unpacked JAR for any <code>.json</code> files. There is a convention that stub definitions are placed under the <code>mappings</code> folder. So it will pick <code>shouldMarkClientAsFraud.json</code>, <code>notAWireMockMapping.json</code> and <code>shouldSayHello.json</code> files.</p>

<p>Next, a WireMock instance is started for each dependency and every found JSON is attempted to be parsed as a WireMock stub definition. Any exceptions at this point are ignored (so assuming that <code>notAWireMockMapping.json</code> is not a valid WireMock definition, the exception will be suppressed). In our scenario 2 WireMock servers will be started - one for <code>service3</code> and one for <code>service4</code>.</p>

<p>That way you don&rsquo;t have to copy the stubs manually. The stubs are centralized since they are stored in a Maven repository. It&rsquo;s extremely important cause <em>Stub Runner</em> downloads always the newest version of the stubs so you can be sure that your tests will break the moment someone does an incompatible change.</p>

<h3>API</h3>

<p>From the developer&rsquo;s perspective there are only a handful of <em>Stub Runner&rsquo;s</em> classes that should be used. In the majority of cases you will use the following ones:</p>

<h4>StubFinder</h4>

<p>An interface that allows you to find the URL of the started WireMock instance. You can find that URL by
passing the Ivy notation (<code>groupId:artifactId</code>) or just the <code>artifactId</code> - <em>Stub Runner</em> will try to take care of the rest.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">interface</span> <span class="nc">StubFinder</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * For the given groupId and artifactId tries to find the matching</span>
</span><span class='line'><span class="cm">   * URL of the running stub.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @param groupId - might be null. In that case a search only via artifactId takes place</span>
</span><span class='line'><span class="cm">   * @return URL of a running stub or null if not found</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">URL</span> <span class="nf">findStubUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">String</span> <span class="n">artifactId</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * For the given Ivy notation {@code groupId:artifactId} tries to find the matching</span>
</span><span class='line'><span class="cm">   * URL of the running stub. You can also pass only {@code artifactId}.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @param ivyNotation - Ivy representation of the Maven artifact</span>
</span><span class='line'><span class="cm">   * @return URL of a running stub or null if not found</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">URL</span> <span class="nf">findStubUrl</span><span class="o">(</span><span class="n">String</span> <span class="n">ivyNotation</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Returns all running stubs</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">RunningStubs</span> <span class="nf">findAllRunningStubs</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>RunningStubs</h4>

<p>A structure representing the already running stubs. Give you some helper methods to retrieve Ivy representation of a particular stub, find a port for a stub etc.</p>

<p><img src="http://toomuchcoding.com/images/accurest/stubrunner/running_stubs.png" alt="RunningStubs" /></p>

<h4>StubRunning</h4>

<p>A contract for classes that can run the stubs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">interface</span> <span class="nc">StubRunning</span> <span class="kd">extends</span> <span class="n">Closeable</span><span class="o">,</span> <span class="n">StubFinder</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Runs the stubs and returns the {@link RunningStubs}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="n">RunningStubs</span> <span class="nf">runStubs</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>StubRunner</h4>

<p>Represents a single instance of ready-to-run stubs. It can run the stubs and will return the running instance of WireMock wrapped in <code>RunningStubs</code> class. Since it&rsquo;s implementing <code>StubFinder</code> can also be queried if the current groupid and artifactid are matching the corresponding running stub.</p>

<h4>BatchStubRunner</h4>

<p>If you have multiple services for which you want to run the WireMocks with stubs it&rsquo;s enough to use <code>BatchStubRunner</code>. It iterates over the given <code>Iterable</code> of <code>StubRunner</code> and executes the logic on each of them.</p>

<h2>Running Stub Runner</h2>

<p>In all the examples below let&rsquo;s assume that the stubs are stored in the Maven repository available under <code>http://toomuchcoding.com</code> URL. As <em>service2</em> I&rsquo;d like to download the stubs of <code>com.toomuchcoding:service3</code> and
<code>com.toomuchcoding:service4</code> services.</p>

<h3>Stub Runner as a fat JAR</h3>

<h4>How to use it?</h4>

<p><em>Stub Runner</em> comes with a main class (<code>io.codearte.accurest.stubrunner.StubRunnerMain</code>) which you can run with the following options:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'> <span class="o">-</span><span class="n">maxp</span> <span class="o">(--</span><span class="n">maxPort</span><span class="o">)</span> <span class="n">N</span>            <span class="o">:</span> <span class="n">Maximum</span> <span class="n">port</span> <span class="n">value</span> <span class="n">to</span> <span class="n">be</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">the</span>
</span><span class='line'>                                  <span class="n">Wiremock</span> <span class="n">instance</span><span class="o">.</span> <span class="n">Defaults</span> <span class="n">to</span> <span class="mi">15000</span>
</span><span class='line'>                                  <span class="o">(</span><span class="k">default</span><span class="o">:</span> <span class="mi">15000</span><span class="o">)</span>
</span><span class='line'> <span class="o">-</span><span class="n">minp</span> <span class="o">(--</span><span class="n">minPort</span><span class="o">)</span> <span class="n">N</span>            <span class="o">:</span> <span class="n">Minimal</span> <span class="n">port</span> <span class="n">value</span> <span class="n">to</span> <span class="n">be</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">the</span>
</span><span class='line'>                                  <span class="n">Wiremock</span> <span class="n">instance</span><span class="o">.</span> <span class="n">Defaults</span> <span class="n">to</span> <span class="mi">10000</span>
</span><span class='line'>                                  <span class="o">(</span><span class="k">default</span><span class="o">:</span> <span class="mi">10000</span><span class="o">)</span>
</span><span class='line'> <span class="o">-</span><span class="n">s</span> <span class="o">(--</span><span class="n">stubs</span><span class="o">)</span> <span class="n">VAL</span>               <span class="o">:</span> <span class="n">Comma</span> <span class="n">separated</span> <span class="n">list</span> <span class="n">of</span> <span class="n">Ivy</span> <span class="n">representation</span> <span class="n">of</span>
</span><span class='line'>                                  <span class="n">jars</span> <span class="n">with</span> <span class="n">stubs</span><span class="o">.</span> <span class="n">Eg</span><span class="o">.</span> <span class="nl">groupid:</span><span class="n">artifactid1</span><span class="o">,</span><span class="n">group</span>
</span><span class='line'>                                  <span class="nl">id2:artifactid2:</span><span class="n">classifier</span>
</span><span class='line'> <span class="o">-</span><span class="n">sr</span> <span class="o">(--</span><span class="n">stubRepositoryRoot</span><span class="o">)</span> <span class="n">VAL</span> <span class="o">:</span> <span class="n">Location</span> <span class="n">of</span> <span class="n">a</span> <span class="n">Jar</span> <span class="n">containing</span> <span class="n">server</span> <span class="n">where</span> <span class="n">you</span>
</span><span class='line'>                                  <span class="n">keep</span> <span class="n">your</span> <span class="nf">stubs</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span> <span class="nl">http:</span><span class="c1">//nexus.net/content</span>
</span><span class='line'>                                  <span class="s">/repositories/</span><span class="n">repository</span><span class="o">)</span>
</span><span class='line'> <span class="o">-</span><span class="n">ss</span> <span class="o">(--</span><span class="n">stubsSuffix</span><span class="o">)</span> <span class="n">VAL</span>        <span class="o">:</span> <span class="n">Suffix</span> <span class="k">for</span> <span class="n">the</span> <span class="n">jar</span> <span class="n">containing</span> <span class="n">stubs</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">g</span><span class="o">.</span>
</span><span class='line'>                                  <span class="s1">&#39;stubs&#39;</span> <span class="k">if</span> <span class="n">the</span> <span class="n">stub</span> <span class="n">jar</span> <span class="n">would</span> <span class="n">have</span> <span class="n">a</span> <span class="s1">&#39;stubs&#39;</span>
</span><span class='line'>                                  <span class="n">classifier</span> <span class="k">for</span> <span class="nl">stubs:</span> <span class="n">foobar</span><span class="o">-</span><span class="n">stubs</span> <span class="o">).</span>
</span><span class='line'>                                  <span class="n">Defaults</span> <span class="n">to</span> <span class="s1">&#39;stubs&#39;</span> <span class="o">(</span><span class="k">default</span><span class="o">:</span> <span class="n">stubs</span><span class="o">)</span>
</span><span class='line'> <span class="o">-</span><span class="n">wo</span> <span class="o">(--</span><span class="n">workOffline</span><span class="o">)</span>            <span class="o">:</span> <span class="n">Switch</span> <span class="n">to</span> <span class="n">work</span> <span class="n">offline</span><span class="o">.</span> <span class="n">Defaults</span> <span class="n">to</span> <span class="s1">&#39;false&#39;</span>
</span><span class='line'>                                  <span class="o">(</span><span class="k">default</span><span class="o">:</span> <span class="kc">false</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can run that main class from IDE or build yourself a fat JAR. To do that just call the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">./</span><span class="n">gradlew</span> <span class="n">stub</span><span class="o">-</span><span class="n">runner</span><span class="o">-</span><span class="nl">root:</span><span class="n">stub</span><span class="o">-</span><span class="nl">runner:</span><span class="n">shadowJar</span> <span class="o">-</span><span class="n">PfatJar</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then inside the <code>build/lib</code> there will be a fat JAR with classifier <code>fatJar</code> waiting for you to execute.</p>

<p>Coming back to our example once the fat JAR is built I would just call the following command the retrieve the stubs of <em>service3</em> and <em>service4</em> from the Maven repository available at <code>http://toomuchcoding.com</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">stub</span><span class="o">-</span><span class="n">runner</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">4</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">-</span><span class="n">fatJar</span><span class="o">.</span><span class="na">jar</span> <span class="o">-</span><span class="n">sr</span> <span class="nl">http:</span><span class="c1">//toomuchcoding.com -s com.toomuchcoding:service3:stubs,com.toomuchcoding.service4</span>
</span></code></pre></td></tr></table></div></figure>


<h4>When to use it?</h4>

<p>Running <em>Stub Runner</em> as a main class makes most sense when you&rsquo;re running some fast smoke tests on a deployed application where you don&rsquo;t want to download and run all the collaborators of that application. For more rationale behind such an approach you can check my article about <a href="http://toomuchcoding.com/blog/2015/09/27/microservice-deployment/">Microservice Deployment</a></p>

<h3>Stub Runner JUnit Rule</h3>

<h4>How to use it?</h4>

<p>You can use the <em>Stub Runner&rsquo;s</em> JUnit rule to automatically download and run the stubs during your tests. The <code>AccurestRule</code> implements the <code>StubFinder</code> interface thus you can easily find the URLs of the services that you&rsquo;re interested in.</p>

<p>This is how you could do it with Spock:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">class</span> <span class="nc">SomeSpec</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ClassRule</span> <span class="nd">@Shared</span> <span class="n">AccurestRule</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccurestRule</span><span class="o">()</span>
</span><span class='line'>      <span class="o">.</span><span class="na">repoRoot</span><span class="o">(</span><span class="s1">&#39;http://toomuchcoding.com&#39;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">downloadStub</span><span class="o">(</span><span class="s2">&quot;com.toomuchcoding&quot;</span><span class="o">,</span> <span class="s2">&quot;service3&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">downloadStub</span><span class="o">(</span><span class="s2">&quot;com.toomuchcoding:service4&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="s1">&#39;should do something useful when service3 is called&#39;</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nl">given:</span>
</span><span class='line'>            <span class="n">URL</span> <span class="n">service3Url</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s1">&#39;com.toomuchcoding&#39;</span><span class="o">,</span> <span class="s1">&#39;service3&#39;</span><span class="o">)</span>
</span><span class='line'>        <span class="nl">expect:</span>
</span><span class='line'>            <span class="n">somethingUseful</span><span class="o">(</span><span class="n">service3Url</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="s1">&#39;should do something even more useful when service4 is called&#39;</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nl">given:</span>
</span><span class='line'>            <span class="n">URL</span> <span class="n">service4Url</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s1">&#39;service4&#39;</span><span class="o">)</span>
</span><span class='line'>        <span class="nl">expect:</span>
</span><span class='line'>            <span class="n">somethingMoreUseful</span><span class="o">(</span><span class="n">service4Url</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or with plain Java JUnit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SomeTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ClassRule</span> <span class="kd">public</span> <span class="kd">static</span> <span class="n">AccurestRule</span> <span class="n">rule</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccurestRule</span><span class="o">()</span>
</span><span class='line'>      <span class="o">.</span><span class="na">repoRoot</span><span class="o">(</span><span class="s2">&quot;http://toomuchcoding.com&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">downloadStub</span><span class="o">(</span><span class="s2">&quot;com.toomuchcoding&quot;</span><span class="o">,</span> <span class="s2">&quot;service3&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">downloadStub</span><span class="o">(</span><span class="s2">&quot;com.toomuchcoding:service4&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">should_do_something_useful_when_service3_is_called</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">URL</span> <span class="n">service3Url</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s2">&quot;com.toomuchcoding&quot;</span><span class="o">,</span> <span class="s2">&quot;service3&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">somethingUseful</span><span class="o">(</span><span class="n">service3Url</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">should_do_something_even_more_useful_when_service4_is_called</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">URL</span> <span class="n">service4Url</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s2">&quot;service4&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">somethingMoreUseful</span><span class="o">(</span><span class="n">service4Url</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>When to use it?</h4>

<p>You can use this rule in any place you want to if we don&rsquo;t provide any integration with an existing framework.</p>

<h3>Stub Runner Spring</h3>

<h4>How to use it?</h4>

<p>You can use the <em>Stub Runner&rsquo;s</em> Spring configuration to download the stubs of your collaborators and run the WireMock server upon Spring context booting. We&rsquo;re providing the <code>StubRunnerConfiguration</code> that you can import in your tests. In that configuration we&rsquo;re registering a <code>StubFinder</code> bean that you can autowire in your tests.</p>

<p>Having the following <code>application.yaml</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stubrunner.stubs.repository.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://toomuchcoding.com</span>
</span><span class='line'><span class="l-Scalar-Plain">stubrunner.stubs.ids</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.toomuchcoding:service3:stubs,com.toomuchcoding.service4</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is how you could do it with Spock</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="n">Config</span><span class="o">,</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">SpringApplicationContextLoader</span><span class="o">)</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">StubRunnerConfigurationSpec</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Autowired</span> <span class="n">StubFinder</span> <span class="n">stubFinder</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="s1">&#39;should do something useful when service3 is called&#39;</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nl">given:</span>
</span><span class='line'>          <span class="n">URL</span> <span class="n">service3Url</span> <span class="o">=</span> <span class="n">stubFinder</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s1">&#39;com.toomuchcoding&#39;</span><span class="o">,</span> <span class="s1">&#39;service3&#39;</span><span class="o">)</span>
</span><span class='line'>      <span class="nl">expect:</span>
</span><span class='line'>          <span class="n">somethingUseful</span><span class="o">(</span><span class="n">service3Url</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="s1">&#39;should do something even more useful when service4 is called&#39;</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nl">given:</span>
</span><span class='line'>          <span class="n">URL</span> <span class="n">service4Url</span> <span class="o">=</span> <span class="n">stubFinder</span><span class="o">.</span><span class="na">findStubUrl</span><span class="o">(</span><span class="s1">&#39;service4&#39;</span><span class="o">)</span>
</span><span class='line'>      <span class="nl">expect:</span>
</span><span class='line'>          <span class="n">somethingMoreUseful</span><span class="o">(</span><span class="n">service4Url</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Configuration</span>
</span><span class='line'>  <span class="nd">@Import</span><span class="o">(</span><span class="n">StubRunnerConfiguration</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@EnableAutoConfiguration</span>
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>When to use it?</h4>

<p>In your tests if you have Spring and don&rsquo;t have Spring Cloud. Also you can add it in compile time (of course you would have to add some Spring profiles so as not to run it on production) to profit from a &ldquo;developer&rdquo; mode of running microservices. That means that if you boot up your application to click around it - all the stubs around you would have already been downloaded and started.</p>

<h3>Stub Runner Spring Cloud</h3>

<h4>How to use it?</h4>

<p>You can use the <em>Stub Runner&rsquo;s</em> Spring Cloud configuration to profit from the stubbed collaborators when using Spring Cloud&rsquo;s abstractions over service discovery and when you&rsquo;re using Netflix Ribbon. <em>Stub Runner Spring Cloud</em> configuration is an <code>AutoConfiguration</code> so it&rsquo;s automatically started for you.</p>

<p>Let&rsquo;s assume that you&rsquo;re referring to <em>service3</em> as <code>service3</code> in your code and to <em>service4</em> as <code>shouldMapThisNameToService4</code>. That means that you&rsquo;re using for example the <code>@LoadBalanced</code> <code>RestTemplate</code> in the following way (don&rsquo;t use field injection as I do in this example!!):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="nd">@Component</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">SomeClass</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Autowired</span> <span class="nd">@LoadBalanced</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="nf">doSth</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// code...</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">service3Response</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s1">&#39;http://service3/name&#39;</span><span class="o">,</span> <span class="n">String</span><span class="o">)</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">service4Response</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="s1">&#39;http://shouldMapThisNameToService4/name&#39;</span><span class="o">,</span> <span class="n">String</span><span class="o">)</span>
</span><span class='line'>    <span class="c1">// more code...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If the service Id that you&rsquo;re using to call other services maps exactly to the name of the artifact Id in a Maven repository then you&rsquo;re lucky and don&rsquo;t have to do anything to find your running stubs. If however that&rsquo;s not the case - don&rsquo;t worry, you&rsquo;ll just have to map it yourself.</p>

<p>The <code>stubrunner.stubs.idsToServiceIds</code> property is the root path to a map in which the <em>key</em> is the <em>artifactID</em> of the downloaded stub and the <em>value</em> is the <em>serviceId</em> used in the code.</p>

<p>Having the following <code>application.yaml</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stubrunner.stubs.repository.root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://toomuchcoding.com</span>
</span><span class='line'><span class="l-Scalar-Plain">stubrunner.stubs.ids</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">com.toomuchcoding:service3:stubs,com.toomuchcoding.service4</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">stubrunner.stubs.idsToServiceIds</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service4</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">shouldMapThisNameToService4</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is how you could do it with Spock</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="n">Config</span><span class="o">,</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">SpringApplicationContextLoader</span><span class="o">)</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">StubRunnerConfigurationSpec</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Autowired</span> <span class="n">SomeClass</span> <span class="n">someClass</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">def</span> <span class="s1">&#39;should not explode&#39;</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nl">when:</span>
</span><span class='line'>          <span class="n">someClass</span><span class="o">.</span><span class="na">doSth</span><span class="o">()</span>
</span><span class='line'>      <span class="nl">expect:</span>
</span><span class='line'>          <span class="n">noExceptionThrown</span><span class="o">()</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Configuration</span>
</span><span class='line'>  <span class="nd">@EnableAutoConfiguration</span>
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>When to use it?</h4>

<p>When you&rsquo;re using Spring Cloud. You can profit from <code>Stub Runner Spring Cloud</code> also in &ldquo;developer&rdquo; mode as presented in the <code>Stub Runner Spring</code> section.</p>

<h3>Additional Configuration Options</h3>

<p>You can set the default value of the Maven repository by means of a system property:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="o">-</span><span class="n">Dstubrunner</span><span class="o">.</span><span class="na">stubs</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">root</span><span class="o">=</span><span class="nl">http:</span><span class="c1">//your.maven.repo.com</span>
</span></code></pre></td></tr></table></div></figure>


<p>The list of configurable properties contains:</p>

<table>
<thead>
<tr>
<th> Name </th>
<th> Default value </th>
<th> Description </th>
</tr>
</thead>
<tbody>
<tr>
<td> stubrunner.port.range.min </td>
<td> 10000 </td>
<td> Minimal value of a port for a WireMock server </td>
</tr>
<tr>
<td> stubrunner.port.range.max </td>
<td> 15000 </td>
<td> Maximum value of a port for a WireMock server </td>
</tr>
<tr>
<td> stubrunner.stubs.repository.root </td>
<td>  </td>
<td> Address to your M2 repo (will point to local M2 repo if none is provided) </td>
</tr>
<tr>
<td> stubrunner.stubs.classifier </td>
<td> stubs </td>
<td> Default classifier for the JARs containing stubs </td>
</tr>
<tr>
<td> stubrunner.work-offline </td>
<td> false </td>
<td> Should try to connect to any repo to download stubs (useful if there&rsquo;s no internet) </td>
</tr>
<tr>
<td> stubrunner.stubs </td>
<td> </td>
<td> Default comma separated list of stubs to download </td>
</tr>
</tbody>
</table>


<h2>Summary</h2>

<p><em>Stub Runner</em>:</p>

<ul>
<li>Has already proven to be a very useful tool when doing CDC.</li>
<li>Was battle tested and more companies are declaring their interest in using it.</li>
<li>Helps you produce an API that should make both sides (server and the client) equally happy (or unhappy but still they&rsquo;re both equal in their emotions ;) ).</li>
<li>Is language / technology agnostic - you can run it as a fat JAR, use it with Spring, Guice or whatever you want.</li>
<li>Helps you speed up the feedback cycle both from the API design and the compatibility perspective.</li>
</ul>


<h2>Links</h2>

<ul>
<li><a href="https://github.com/Codearte/accurest">AccuREST Github Repository</a></li>
<li><a href="https://github.com/Codearte/accurest/wiki/8.-Stub-Runner">Stub Runner WIKI</a></li>
<li><a href="https://gitter.im/Codearte/accurest">AccuREST Gitter</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JSON Assert 0.3.0 released]]></title>
    <link href="http://toomuchcoding.com/blog/2016/03/27/json-assert-0-dot-3-0-released/"/>
    <updated>2016-03-27T23:17:21+02:00</updated>
    <id>http://toomuchcoding.com/blog/2016/03/27/json-assert-0-dot-3-0-released</id>
    <content type="html"><![CDATA[<p>I&rsquo;m pleased to announce that JSON Assert version 0.3.0 got released! The following features have been added</p>

<ul>
<li><a href="https://github.com/marcingrzejszczak/jsonassert/issues/6">Building String JSON Path</a></li>
<li><a href="https://github.com/marcingrzejszczak/jsonassert/issues/7">Pass fields as array of Strings</a></li>
</ul>


<p>and in 0.2.2 the <a href="https://github.com/marcingrzejszczak/jsonassert/issues/5">annoying warning message got removed</a></p>

<!-- more -->


<h2>Building String JSON Path</h2>

<p>Writing JSON Paths to assert JSON is no fun at all&hellip; That&rsquo;s why JSON Assert was created in the first place.
One doesn&rsquo;t always want to use this library to perform assertions though. But what one wants to profit from
is the fluent interface to create the JSON Path expression.</p>

<p>That&rsquo;s why with 0.3.0 you can use the new class called <code>JsonPath</code>. It has a single static method <code>builder()</code>
with which you can&hellip; well&hellip; build the JSON Path. Remember to call <code>jsonPath()</code> to get its String value.</p>

<p>So for instance running this code:</p>

<p><code>JsonPath.builder().field("some").field("nested").field("anothervalue").isEqualTo(4).jsonPath()</code></p>

<p>would result in creating the following String JSON Path representation:</p>

<p><code>$.some.nested[?(@.anothervalue == 4)]</code></p>

<p>Other examples:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>JsonPath.builder().field("some").field("nested").array("withlist").contains("name").isEqualTo("name1").jsonPath() === '''$.some.nested.withlist[*][?(@.name == 'name1')]'''
</span><span class='line'>JsonPath.builder().field("some").field("nested").field("json").isEqualTo("with \"val'ue").jsonPath() === '''$.some.nested[?(@.json == 'with "val\\'ue')]'''
</span><span class='line'>JsonPath.builder().field("some", "nested", "json").isEqualTo("with \"val'ue").jsonPath() === '''$.some.nested[?(@.json == 'with "val\\'ue')]'''</span></code></pre></td></tr></table></div></figure>


<h2>Pass fields as array of Strings</h2>

<p>This is a small, handy feature that allows you to write less code. Often you iterate over a JSON that has plenty of fields. With the 0.3.0 release
instead of writing:</p>

<p><code>assertThat(json).field("some").field("nested").field("json").isEqualTo("with \"val'ue")</code></p>

<p>you can write</p>

<p><code>assertThat(json1).field("some", "nested", "json").isEqualTo("with \"val'ue")</code></p>

<p>You get a method that allows you to traverse the JSON fields by passing an array of field names.</p>

<h2>Contact</h2>

<p>Remember that JSON Assert has its own <a href="https://gitter.im/marcingrzejszczak/jsonassert">Gitter channel</a> so in case of questions do not hesitate
to contact me there.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spring Cloud Sleuth RC1 deployed]]></title>
    <link href="http://toomuchcoding.com/blog/2016/03/25/spring-cloud-sleuth-rc1-deployed/"/>
    <updated>2016-03-25T14:18:22+01:00</updated>
    <id>http://toomuchcoding.com/blog/2016/03/25/spring-cloud-sleuth-rc1-deployed</id>
    <content type="html"><![CDATA[<p>On the 24.03.2016 we&rsquo;ve managed to move our <a href="https://spring.io/blog/2016/03/24/spring-cloud-brixton-rc1-is-now-available">release train called Brixton to the next station: RC1</a>.
I&rsquo;m really happy about this cause it cost us a lot of energy but it was worth it!</p>

<p>I&rsquo;m recently mostly focusing on the <a href="http://cloud.spring.io/spring-cloud-sleuth/spring-cloud-sleuth.html">Spring Cloud Sleuth project</a> and actually quite gigantic changes happened there since the M5 release. In this short post I&rsquo;ll show you the rationale and describe briefly the features related to span naming and customizations related to span propagation.</p>

<!-- more -->


<h2>What is Spring Cloud Sleuth?</h2>

<p>For those who don&rsquo;t know what Spring Cloud Sleuth is - it&rsquo;s a library that implements a distributed tracing solution for Spring Cloud. You can check its code at <a href="https://github.com/spring-cloud/spring-cloud-sleuth">Github</a>.</p>

<p>We&rsquo;re also trying to be aligned with the concepts, terminology and approaches present in the <a href="http://opentracing.io/">OpenTracing Project</a>.</p>

<h2>Distributed tracing terminology</h2>

<p>I&rsquo;ll quote the <a href="http://cloud.spring.io/spring-cloud-sleuth/spring-cloud-sleuth.html">documentation</a> to present some of the basic concepts of distributed tracing.</p>

<blockquote><p><em>Span</em>: The basic unit of work. For example, sending an RPC is a new span, as is sending a response to an RPC. Span’s are identified by a unique 64-bit ID for the span and another 64-bit ID for the trace the span is a part of. Spans also have other data, such as descriptions, timestamped events, key-value annotations (tags), the ID of the span that caused them, and process ID’s (normally IP address).</p>

<p>Spans are started and stopped, and they keep track of their timing information. Once you create a span, you must stop it at some point in the future.</p>

<p><em>Trace</em>: A set of spans forming a tree-like structure. For example, if you are running a distributed big-data store, a trace might be formed by a put request.</p>

<p><em>Annotation</em>: is used to record existence of an event in time. Some of the core annotations used to define the start and stop of a request are:</p>

<ul>
<li><p><em>cs</em> - Client Sent - The client has made a request. This annotation depicts the start of the span.</p></li>
<li><p><em>sr</em> - Server Received - The server side got the request and will start processing it. If one subtracts the cs timestamp from this timestamp one will receive the network latency.</p></li>
<li><p><em>ss</em> - Server Sent - Annotated upon completion of request processing (when the response got sent back to the client). If one subtracts the sr timestamp from this timestamp one will receive the time needed by the server side to process the request.</p></li>
<li><p><em>cr</em> - Client Received - Signifies the end of the span. The client has successfully received the response from the server side. If one subtracts the cs timestamp from this timestamp one will receive the whole time needed by the client to receive the response from the server.</p></li>
</ul>
</blockquote>

<p>Ok since now we&rsquo;re on the same page with the terminology let&rsquo;s see what&rsquo;s new in Sleuth.</p>

<h2>Span creation and naming</h2>

<h3>Rationale</h3>

<p>A really big problem that is there in the distributed tracing world is the issue related to naming spans. Actually that topic can be looked at from two angles.</p>

<p>First one is related to what the name of the span should look like. Should be a long and descriptive name or quite the contrary? As we write in the documentation:</p>

<blockquote><p>The name should be low cardinality (e.g. not include identifiers).</p></blockquote>

<p>Finding the name for the span is not that big of a problem from library&rsquo;s perspective. You just pass on to a span whatever the user provides. But what about the situations in which some operation is deferred in time? Or scheduled at certain intervals?</p>

<p>Second one is related to a bigger issue: for the sake of consistency of passing tracing data, should we enforce creating spans? Should we be <em>eager</em> with that or allow the user to control span creation? Cause in that way we can have a problem how to name this artificial instance.</p>

<p>For RC1 we&rsquo;ve decided that we will be eager in creating span names - but <a href="https://github.com/spring-cloud/spring-cloud-sleuth/issues/180">we will come back to the topic in the future releases</a>.</p>

<h3>Naming spans</h3>

<p>Ok so we know the why, now let&rsquo;s move to the how&hellip; There is quite a lot of instrumentation going on in Sleuth so sometimes the names of spans could sound artificial (e.g. <em>async</em> for asynchronous operations). When talking about runnables and callables often you&rsquo;re dealing with code similar to this one:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Runnable runnable = new Runnable() {
</span><span class='line'>  @Override public void run() {
</span><span class='line'>      // perform logic
</span><span class='line'>  }
</span><span class='line'>});
</span><span class='line'>Future&lt;?&gt; future = executorService.submit(runnable);
</span><span class='line'>// ... some additional logic ...
</span><span class='line'>future.get();</span></code></pre></td></tr></table></div></figure>


<p>What the <code>Runnable</code> is an operation that you would like to wrap in a span. What should be the name of that span? How can you pass it to the <code>Tracer</code> so that the span name is set?</p>

<p>To answer those issues we&rsquo;ve introduced two approaches</p>

<ul>
<li>a <code>@SpanName</code> annotation for an explicit class that implements <code>Runnable</code> or <code>Callable</code></li>
<li><code>toString()</code> method resolution of an anonymous instance of either of those interfaces</li>
</ul>


<p>Most likely in the future releases <code>@SpanName</code> or its modification will be used more heavily to provide explicit names of spans.</p>

<p>Anyways examples could look like those in the documentation. Example for <code>@SpanName</code> annotated class:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@SpanName("calculateTax")
</span><span class='line'>class TaxCountingRunnable implements Runnable {
</span><span class='line'>
</span><span class='line'>  @Override public void run() {
</span><span class='line'>      // perform logic
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>and an anonymous instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>new TraceRunnable(tracer, spanNamer, new Runnable() {
</span><span class='line'>  @Override public void run() {
</span><span class='line'>      // perform logic
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  @Override public String toString() {
</span><span class='line'>      return "calculateTax";
</span><span class='line'>  }
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>Both will have the same span name. Remember that both <code>Runnables</code> should be wrapped in a <code>TraceRunnable</code> instance.</p>

<h3>Customization of span propagation</h3>

<p>It&rsquo;s pretty obvious that there&rsquo;s a lot of companies that have already created some form of distributed tracing instrumentation. In Spring Cloud Sleuth we&rsquo;re expecting the tracing headers to be containing certain names like <code>X-B3-TraceId</code> for the trace id containing headers or <code>X-B3-SpanId</code> for the span related one.</p>

<p>One of the first issues that we&rsquo;ve created was related to <a href="https://github.com/spring-cloud/spring-cloud-sleuth/issues/19">support configurable header names</a> but actually we&rsquo;ve developed it quite late. Anyways with RC1 it&rsquo;s possible to customize Sleuth in such a way that it&rsquo;s compatible with your system&rsquo;s nomenclature. Let&rsquo;s define two terms before we go any further - <code>Injector</code> and <code>Extractor</code>.</p>

<h4>Injectors</h4>

<p>In Spring Cloud Sleuth an <code>Injector</code> is actually a functional interface called <code>SpanInjector</code>. It has the following method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void inject(Span span, T carrier);</span></code></pre></td></tr></table></div></figure>


<p>Its purpose is to take whatever is necessary from a <code>span</code> and
inject it to the <code>carrier</code>. Let&rsquo;s assume that in your system you don&rsquo;t set the headers for trace id with the name <code>X-B3-TraceId</code> but you call it <code>correlationId</code> and <code>mySpanId</code> for <code>X-B3-SpanId</code>. Then you would have to override the behavior of Sleuth by registering a custom implementation of the <code>SpanInjector</code>. Let&rsquo;s look at the following snippets from the documentation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CustomHttpServletResponseSpanInjector implements SpanInjector&lt;HttpServletResponse&gt; {
</span><span class='line'>
</span><span class='line'>  @Override
</span><span class='line'>  public void inject(Span span, HttpServletResponse carrier) {
</span><span class='line'>      carrier.addHeader("correlationId", Span.idToHex(span.getTraceId()));
</span><span class='line'>      carrier.addHeader("mySpanId", Span.idToHex(span.getSpanId()));
</span><span class='line'>      // inject the rest of Span values to the header
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Note that this approach will work with Zipkin only if your values that you&rsquo;re passing are Zipkin-compatible. That means that the IDs are 64bit numbers.</p>

<p>Also you may wonder why do we convert values using <code>Span.idToHex</code>. We&rsquo;ve decided that we want the values of ids in the logs and in the message headers to be the very same values as the one that you can later see in Zipkin. That way you can just copy the value and put it into Zipkin to debug your system.</p>

<p>Once you have the <code>SpanInjector</code> you have to register it as a bean with <code>@Primary</code> annotation as presented below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@Bean
</span><span class='line'>@Primary
</span><span class='line'>SpanInjector&lt;HttpServletResponse&gt; customHttpServletResponseSpanInjector() {
</span><span class='line'>  return new CustomHttpServletResponseSpanInjector();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h4>Extractors</h4>

<p>In Spring Cloud Sleuth an <code>Extractor</code> is actually a functional interface called <code>SpanExtractor</code>. It has the following method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Span joinTrace(T carrier);</span></code></pre></td></tr></table></div></figure>


<p>Its purpose is to create a Span from the provided carrier. Let&rsquo;s have the same assumption as with the <code>SpanInjector</code> and let&rsquo;s consider a case where traceId header is named <code>correlationId</code> and spanId header is <code>mySpanId</code>. Then we customize the Spring context by providing our own implementation of the <code>SpanExtractor</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class CustomHttpServletRequestSpanExtractor implements SpanExtractor&lt;HttpServletRequest&gt; {
</span><span class='line'>
</span><span class='line'>  @Override
</span><span class='line'>  public Span joinTrace(HttpServletRequest carrier) {
</span><span class='line'>      long traceId = Span.hexToId(carrier.getHeader("correlationId"));
</span><span class='line'>      long spanId = Span.hexToId(carrier.getHeader("mySpanId"));
</span><span class='line'>      // extract all necessary headers
</span><span class='line'>      Span.SpanBuilder builder = Span.builder().traceId(traceId).spanId(spanId);
</span><span class='line'>      // build rest of the Span
</span><span class='line'>      return builder.build();
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Again note that we&rsquo;re considering that the values are Zipkin compatible (64bit values for ids). Also note that we&rsquo;ve assumed that the ids are sent in a hexadecimal form like they are presented in the Zipkin UI. That&rsquo;s why we used the <code>Span.hexToId</code> method to convert it back to long again.</p>

<h2>Summary</h2>

<p>In this very short post you could see two quite big features available in the RC1 release. You can check <a href="http://cloud.spring.io/spring-cloud-sleuth/spring-cloud-sleuth.html">Spring Cloud Sleuth documentation</a> for more information about the integrations and configurations of Sleuth. Actually you can check all the things that have changed in the RC1 release by checking the <a href="https://github.com/spring-cloud/spring-cloud-sleuth/issues?q=is%3Aissue+is%3Aclosed+milestone%3A1.0.0.RC1">closed issues</a> and <a href="https://github.com/spring-cloud/spring-cloud-sleuth/pulls?q=is%3Apr+milestone%3A1.0.0.RC1+is%3Aclosed">merged PRs</a>.</p>

<p>In case of any questions do not hesitate to ping us on the <a href="https://gitter.im/spring-cloud/spring-cloud-sleuth">Gitter channel</a> or <a href="https://github.com/spring-cloud/spring-cloud-sleuth/issues">file an issue on Github</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JSON Assert 0.2.1 released]]></title>
    <link href="http://toomuchcoding.com/blog/2016/03/11/json-assert-0-dot-2-1-released/"/>
    <updated>2016-03-11T23:33:30+01:00</updated>
    <id>http://toomuchcoding.com/blog/2016/03/11/json-assert-0-dot-2-1-released</id>
    <content type="html"><![CDATA[<p>I&rsquo;m pleased to announce that JSON Assert version 0.2.1 got released! The following features have been added</p>

<ul>
<li><a href="https://github.com/marcingrzejszczak/jsonassert/issues/2">AssertJ support</a></li>
<li><a href="https://github.com/marcingrzejszczak/jsonassert/issues/3">Bumped up JSON Path to 2.2.0</a></li>
<li><a href="https://github.com/marcingrzejszczak/jsonassert/issues/4">Fixed a bug related to chars escaping</a></li>
<li>I&rsquo;ve changed README.md to README.ascidoc</li>
</ul>


<!-- more -->


<h1>Breaking changes</h1>

<p>I&rsquo;ve changed the groupId and packages of the library so you have to do the migration of both.</p>

<h2>GroupId</h2>

<p>Was:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>com.blogspot.toomuchcoding</span></code></pre></td></tr></table></div></figure>


<p>Is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>com.toomuchcoding.jsonassert</span></code></pre></td></tr></table></div></figure>


<h2>Package</h2>

<p>Was:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>com.blogspot.toomuchcoding.jsonassert</span></code></pre></td></tr></table></div></figure>


<p>Is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>com.toomuchcoding.jsonassert</span></code></pre></td></tr></table></div></figure>


<h1>BTW</h1>

<p>I&rsquo;ve created a new page on the website <a href="http://toomuchcoding.com/oss/">OSS</a>. You can check out which OSS projects I&rsquo;ve created or have contributed sth there.
If you don&rsquo;t care - just ignore it ;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Goodbye Blogspot welcome Octopress!]]></title>
    <link href="http://toomuchcoding.com/blog/2016/03/03/goodbye-blogspot-welcome-octopress/"/>
    <updated>2016-03-03T22:53:26+01:00</updated>
    <id>http://toomuchcoding.com/blog/2016/03/03/goodbye-blogspot-welcome-octopress</id>
    <content type="html"><![CDATA[<p>I&rsquo;m more than happy to announce that I&rsquo;ve finally migrated from Blogspot to a decent
blogging technology - Octopress! Thanks to <a href="http://tomaszdziurko.pl/">Tomek Dziurko</a> who
was the one that suggested to choose that technology.</p>

<p>Also as you can see I&rsquo;ve finally bought a domain for the <em>Too Much Coding blog</em> which is
<a href="http://toomuchcoding.com">http://toomuchcoding.com</a>. I don&rsquo;t even know why I&rsquo;m
writing it since you can see the address in your browser ;) You can also send me an email
at <em>blog (at) toomuchcoding.com</em>.</p>

<p>Even though initially I had some doubts about choosing Octopress I have to admit that
it seems like an awesome technology and you should definitely give it a try!</p>

<p>P.S.
We&rsquo;re looking for sponsors for the upcoming <a href="http://warsaw.gr8days.pl">Warsaw GR8 Day Conference</a> (19.03.2016).
Over 60 people have already registered! Contact us to be a part of this gr8 event!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JSON Assert lib released]]></title>
    <link href="http://toomuchcoding.com/blog/2016/02/27/json-assert-lib-released/"/>
    <updated>2016-02-27T23:20:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2016/02/27/json-assert-lib-released</id>
    <content type="html"><![CDATA[<div class='post'>
I'm really happy to present the <a href="https://github.com/marcingrzejszczak/jsonassert">JSON Assert library</a>&nbsp;-&nbsp;over-the-weekend project that came out from the <a href="https://github.com/Codearte/accurest">AccuREST library</a>. This post will describe the rationale behind creating this tool and how to use it.<br /><br /><br /><a name='more'></a>
<!--more-->
<br /><br /><h4>Rationale</h4>In AccuREST (the Consumer Driven Contracts implementation library) we're creating tests of the server side. For more information on what is AccuREST and what Consumer Driven Contracts is check the <a href="https://github.com/Codearte/accurest/wiki">AccurREST wiki</a>. Anyways, we're checking if the response from the server matches the one described in the contract.<br /><br />So having such a Groovy DSL:<br /><br /><pre style="background: #fff; color: black;">io.codearte.accurest.dsl.GroovyDsl<span style="color: #0100b6; font-weight: 700;">.</span>make {<br />    priority <span style="color: #cd0000; font-style: italic;">1</span><br />    request {<br />        method <span style="color: #d80800;">'POST'</span><br />        url <span style="color: #d80800;">'/users/password'</span><br />        headers {<br />            header <span style="color: #d80800;">'Content-Type'</span>: <span style="color: #d80800;">'application/json'</span><br />        }<br />        body(<br />                <span style="color: #c5060b; font-style: italic;">email</span>: $(stub(optional(regex(email()))), test(<span style="color: #d80800;">'abc@abc.com'</span>)),<br />                <span style="color: #c5060b; font-style: italic;">callback_url</span>: $(stub(regex(hostname())), test(<span style="color: #d80800;">'http://partners.com'</span>))<br />        )<br />    }<br />    response {<br />        status <span style="color: #cd0000; font-style: italic;">404</span><br />        headers {<br />            header <span style="color: #d80800;">'Content-Type'</span>: <span style="color: #d80800;">'application/json'</span><br />        }<br />        body(<br />                <span style="color: #c5060b; font-style: italic;">code</span>: value(stub(<span style="color: #d80800;">"123123"</span>), test(optional(<span style="color: #d80800;">"123123"</span>))),<br />                <span style="color: #c5060b; font-style: italic;">message</span>: <span style="color: #d80800;">"User not found by email = [<span style="color: #26b31a;">${value(test(regex(email())), stub('not.existing@user.com'))}</span>]"</span><br />        )<br />    }<br />}<br /></pre><br />Resulted in creation of the following server side response verification<br /><br /><pre style="background: #fff; color: black;"><span style="color: #c5060b; font-style: italic;">given</span>:<br />  def request <span style="color: #0100b6; font-weight: 700;">=</span> given()<br />    .header(<span style="color: #d80800;">'Content-Type'</span>, <span style="color: #d80800;">'application/json'</span>)<br />    .body(<span style="color: #d80800;">'{"email":"abc@abc.com","callback_url":"http://partners.com"}'</span>)<br /><br /> <span style="color: #c5060b; font-style: italic;">when</span>:<br />  def response <span style="color: #0100b6; font-weight: 700;">=</span> given()<span style="color: #0100b6; font-weight: 700;">.</span>spec(request)<br />    .post(<span style="color: #d80800;">"/users/password"</span>)<br /><br /> <span style="color: #c5060b; font-style: italic;">then</span>:<br />  response<span style="color: #0100b6; font-weight: 700;">.</span>statusCode <span style="color: #0100b6; font-weight: 700;">==</span> <span style="color: #cd0000; font-style: italic;">404</span><br />  response<span style="color: #0100b6; font-weight: 700;">.</span>header(<span style="color: #d80800;">'Content-Type'</span>)  <span style="color: #0100b6; font-weight: 700;">==</span> <span style="color: #d80800;">'application/json'</span><br /> <span style="color: #c5060b; font-style: italic;">and</span>:<br />  DocumentContext parsedJson <span style="color: #0100b6; font-weight: 700;">=</span> JsonPath<span style="color: #0100b6; font-weight: 700;">.</span>parse(response<span style="color: #0100b6; font-weight: 700;">.</span>body<span style="color: #0100b6; font-weight: 700;">.</span>asString())<br />  <span style="color: #0100b6; font-weight: 700;">!</span>parsedJson<span style="color: #0100b6; font-weight: 700;">.</span>read(<span style="color: #d80800;">'''$[?(@.code =~ /(123123)?/)]'''</span>, JSONArray)<span style="color: #0100b6; font-weight: 700;">.</span>empty<br />  <span style="color: #0100b6; font-weight: 700;">!</span>parsedJson<span style="color: #0100b6; font-weight: 700;">.</span>read(<span style="color: #d80800;">'''$[?(@.message =~ /User not found by email = <span style="color: #26b31a;">\\</span>[[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+<span style="color: #26b31a;">\\</span>.[a-zA-Z]{2,4}<span style="color: #26b31a;">\\</span>]/)]'''</span>, JSONArray)<span style="color: #0100b6; font-weight: 700;">.</span>empty<br /><br /></pre><br />AccuREST users stated that their biggest problem is this part:<br /><br /><pre style="background: #fff; color: black;"><span style="color: #0100b6; font-weight: 700;">!</span>parsedJson<span style="color: #0100b6; font-weight: 700;">.</span>read(<span style="color: #d80800;">'''$[?(@.code =~ /(123123)?/)]'''</span>, JSONArray)<span style="color: #0100b6; font-weight: 700;">.</span>empty<br />  <span style="color: #0100b6; font-weight: 700;">!</span>parsedJson<span style="color: #0100b6; font-weight: 700;">.</span>read(<span style="color: #d80800;">'''$[?(@.message =~ /User not found by email = <span style="color: #26b31a;">\\</span>[[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+<span style="color: #26b31a;">\\</span>.[a-zA-Z]{2,4}<span style="color: #26b31a;">\\</span>]/)]'''</span>, JSONArray)<span style="color: #0100b6; font-weight: 700;">.</span>empty<br /></pre><br />They said that JSON Paths are too difficult for them to read.<br /><br />That's why I've created the&nbsp;<a href="https://github.com/marcingrzejszczak/jsonassert">JSON Assert library</a>. So that instead of the aforementioned code one gets sth like this:<br /><br /><pre style="background: #fff; color: black;">  assertThatJson(parsedJson)<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">'code'</span>)<span style="color: #0100b6; font-weight: 700;">.</span>matches(<span style="color: #d80800;">'123123?'</span>)<br />  assertThatJson(parsedJson)<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">'message'</span>)<span style="color: #0100b6; font-weight: 700;">.</span>matches(<span style="color: #d80800;">'User not found by email = <span style="color: #26b31a;">\\</span>[[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+<span style="color: #26b31a;">\\</span>.[a-zA-Z]{2,4}<span style="color: #26b31a;">\\</span>]/)]'</span>);<br /></pre><br /><h4>How to add it to your project</h4><br />If your using Gradle just add (<a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3A%22com.blogspot.toomuchcoding%22%20a%3A%22jsonassert%22">check the latest version number</a>):<br /><br /><pre style="background: #fff; color: black;"> testCompile `com<span style="color: #0100b6; font-weight: 700;">.</span>blogspot<span style="color: #0100b6; font-weight: 700;">.</span><span style="color: #c5060b; font-style: italic;">toomuchcoding</span>:<span style="color: #c5060b; font-style: italic;">jsonassert</span>:<span style="color: #cd0000; font-style: italic;">0.1</span><span style="color: #cd0000; font-style: italic;">.2</span>`<br /></pre><br />and if Maven just add:<br /><br /><pre style="background: #fff; color: black;"><span style="color: #1c02ff;">&lt;<span style="font-weight: 700;">dependency</span>&gt;</span><br />    <span style="color: #1c02ff;">&lt;<span style="font-weight: 700;">groupId</span>&gt;</span>com.blogspot.toomuchcoding<span style="color: #1c02ff;">&lt;/<span style="font-weight: 700;">groupId</span>&gt;</span><br />    <span style="color: #1c02ff;">&lt;<span style="font-weight: 700;">artifactId</span>&gt;</span>jsonassert<span style="color: #1c02ff;">&lt;/<span style="font-weight: 700;">artifactId</span>&gt;</span><br />    <span style="color: #1c02ff;">&lt;<span style="font-weight: 700;">version</span>&gt;</span>0.1.2<span style="color: #1c02ff;">&lt;/<span style="font-weight: 700;">version</span>&gt;</span><br /><span style="color: #1c02ff;">&lt;/<span style="font-weight: 700;">dependency</span>&gt;</span><br /></pre><h4><br />How to use it</h4><br />Since almost everything in JSON Assert is package scoped you have access to two public classes. One of which is the &nbsp;<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><a href="https://github.com/marcingrzejszczak/jsonassert/blob/master/src/main/java/com/blogspot/toomuchcoding/jsonassert/JsonAssertion.java">JsonAssertion</a></span> class. It gives you a couple of public methods that give you the entry point to the fluent interface of the library.<br /><br />You can check the JavaDocs of the <a href="https://github.com/marcingrzejszczak/jsonassert/blob/master/src/main/java/com/blogspot/toomuchcoding/jsonassert/JsonVerifiable.java">JsonVerifiable</a> interface in order to see what kind of methods can be used.<br /><br /><h4>Examples</h4><div><br />Best examples are <a href="https://github.com/marcingrzejszczak/jsonassert/blob/master/src/test/groovy/com/blogspot/toomuchcoding/jsonassert/JsonAssertionSpec.groovy">tests</a>. I'll show you a couple of them here.<br /><br /><br /><b>Example 1</b><br /><br />Having a JSON:<br /><br /><pre style="background: #fff; color: black;">[ {<br />                                <span style="color: #d80800;">"some"</span> : {<br />                                    <span style="color: #d80800;">"nested"</span> : {<br />                                        <span style="color: #d80800;">"json"</span> : <span style="color: #d80800;">"with value"</span>,<br />                                        <span style="color: #d80800;">"anothervalue"</span>: <span style="color: #cd0000; font-style: italic;">4</span>,<br />                                        <span style="color: #d80800;">"withlist"</span> : [<br />                                            { <span style="color: #d80800;">"name"</span> :<span style="color: #d80800;">"name1"</span>} , {<span style="color: #d80800;">"name"</span>: <span style="color: #d80800;">"name2"</span>}, {<span style="color: #d80800;">"anothernested"</span>: { <span style="color: #d80800;">"name"</span>: <span style="color: #d80800;">"name3"</span>} }<br />                                        ]<br />                                    }<br />                                }<br />                            },<br />                            {<br />                                <span style="color: #d80800;">"someother"</span> : {<br />                                    <span style="color: #d80800;">"nested"</span> : {<br />                                        <span style="color: #d80800;">"json"</span> : <span style="color: #d80800;">"with value"</span>,<br />                                        <span style="color: #d80800;">"anothervalue"</span>: <span style="color: #cd0000; font-style: italic;">4</span>,<br />                                        <span style="color: #d80800;">"withlist"</span> : [<br />                                            { <span style="color: #d80800;">"name"</span> :<span style="color: #d80800;">"name1"</span>} , {<span style="color: #d80800;">"name"</span>: <span style="color: #d80800;">"name2"</span>}<br />                                        ]<br />                                    }<br />                                }<br />                            }<br />                        ]<br /></pre><br /></div><div><br /></div><div>Instead of writing:</div><div><br /><pre style="background: #fff; color: black;">$[<span style="color: #0100b6; font-weight: 700;">*</span>].some.nested.withlist[<span style="color: #0100b6; font-weight: 700;">*</span>].anothernested[<span style="color: #0100b6; font-weight: 700;">?</span>(@.name == <span style="color: #d80800;">'name3'</span>)]<br /></pre></div><div><br /></div><div>you can write<br /><br /><pre style="background: #fff; color: black;"><span style="color: #3c4c72; font-weight: 700;">assertThat</span>(json)<span style="color: #0100b6; font-weight: 700;">.</span>array()<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">"some"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">"nested"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>array(<span style="color: #d80800;">"withlist"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">"anothernested"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>field(<span style="color: #d80800;">"name"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>isEqualTo(<span style="color: #d80800;">"name3"</span>)<br /></pre><br /><b>Example 2</b><br /><br />Having a JSON:<br /><br /><pre style="background: #fff; color: black;">{<br />    <span style="color: #d80800;">"property1"</span>: [<br />        { <span style="color: #d80800;">"property2"</span>: <span style="color: #d80800;">"test1"</span>},<br />        { <span style="color: #d80800;">"property3"</span>: <span style="color: #d80800;">"test2"</span>}<br />    ]<br />}<br /></pre><br /></div><div><br /></div><div>Instead of writing:</div><div><br /><pre style="background: #fff; color: black;">$.property1[<span style="color: #0100b6; font-weight: 700;">*</span>][<span style="color: #0100b6; font-weight: 700;">?</span>(@.property2 == <span style="color: #d80800;">'test1'</span>)]<br /></pre></div><div><br /></div><div>you can write<br /><br /><pre style="background: #fff; color: black;"><span style="color: #3c4c72; font-weight: 700;">assertThat</span>(json)<span style="color: #0100b6; font-weight: 700;">.</span>array(<span style="color: #d80800;">"property1"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>contains(<span style="color: #d80800;">"property2"</span>)<span style="color: #0100b6; font-weight: 700;">.</span>isEqualTo(<span style="color: #d80800;">"test1"</span>)<br /></pre><br /></div><h4>Future plans</h4><br />It would be nice to:<br /><br /><ul><li>integrate with <a href="http://joel-costigliola.github.io/assertj/">AssertJ</a></li><li>add more <a href="https://github.com/jayway/JsonPath#functions">JSON Path features</a> (functions, filters etc.)</li></ul><div><br /></div><h4>Links</h4><ul><li><a href="https://github.com/marcingrzejszczak/jsonassert">JSON Assert</a></li><li><a href="https://github.com/Codearte/accurest/wiki">AccuREST</a></li><li><a href="https://www.youtube.com/watch?v=daafmTYFoDU">Video about AccuREST </a>by <a href="https://twitter.com/olga_maciaszek">Olga Maciaszek-Sharma</a></li><li><a href="https://github.com/jayway/JsonPath">Jayway JSON Path</a></li><li><a href="http://joel-costigliola.github.io/assertj/">AssertJ</a></li></ul><br /><br /></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Post on Spring blog]]></title>
    <link href="http://toomuchcoding.com/blog/2016/01/04/post-on-spring-blog/"/>
    <updated>2016-01-04T18:28:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2016/01/04/post-on-spring-blog</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />Since December I'm working for Pivotal and the Spring Cloud team. I've just posted my first blog post on the Spring blog. Check it out!<br /><br /><a href="https://spring.io/blog/2016/01/04/testing-spring-cloud-projects">Testing Spring Cloud Projects</a></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Business value gone wild]]></title>
    <link href="http://toomuchcoding.com/blog/2015/10/16/business-value-gone-wild/"/>
    <updated>2015-10-16T17:58:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2015/10/16/business-value-gone-wild</id>
    <content type="html"><![CDATA[<div class='post'>
This blog post will not be about microservices, Spring or any technology that I've already talked about in <a href="http://toomuchcoding.blogspot.com/">Too much coding blog</a>. This time it will be my opinion on two subjects<br /><ul><li>the more and more frequent "it's not my problem" approach in the IT industry running in a corporation.&nbsp;</li><li>the "business value" frenzy of the management</li></ul>This article is definitely not a motivational one. Quite frankly, you might get depressed after reading it. Nonetheless, it's better to know how really corporate life sometimes looks like rather than get hit in the face.<br /><br />TL;DR : the more you care in a corporate enterprise the worse for you. Eventually some developers will hate your ideas of quality and standards because they are paid to tap the keys. Your management will fire you for not bringing "business value". The faster you embrace it, the better for you - you'll start searching for a new job sooner.<br /><div><br /><div><a name='more'></a>
<!--more-->
</div><h4>Features are not only functionalities</h4><div><br />Let's define some facts: IT is paid by the business. Business wants features. IT has to deliver features to gain money. That's a fact and our reality. Even if you hear from your managers that "cleaning technical debt is a necessity" what they really think is:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-htlLzbCyZro/Vh6fjoKG5iI/AAAAAAABILw/_zk7wkxqPoU/s1600/technical_debt.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="224" src="http://4.bp.blogspot.com/-htlLzbCyZro/Vh6fjoKG5iI/AAAAAAABILw/_zk7wkxqPoU/s320/technical_debt.jpg" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div></div><div><br /></div><div>And actually that's not bizarre - business has no understanding of the technical aspects of the IT work. Here we can discern two types of business people:<br /><ul><li>they don't get technical aspects, but they trust the engineers</li><li>they don't care about technical aspects and they won't listen to any of the programmers' advice</li></ul><br />If you have the latter business people then most likely you're in this situation:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-LwS3CWbA0b0/Vh6qyT0FmbI/AAAAAAABIMM/1xY8oezZhFk/s1600/before.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-LwS3CWbA0b0/Vh6qyT0FmbI/AAAAAAABIMM/1xY8oezZhFk/s1600/before.jpg" /></a></div><br />and actually you should be doing such a shift:<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-TCHAm6Q0yT0/Vh6oKJF3mLI/AAAAAAABIMA/pjQoINeQ35c/s1600/cable_change.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="210" src="http://1.bp.blogspot.com/-TCHAm6Q0yT0/Vh6oKJF3mLI/AAAAAAABIMA/pjQoINeQ35c/s320/cable_change.jpg" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">http://www.technalytical.com/2012/04/aesthetical-cable-management-before-and.html</td></tr></tbody></table>In order to grow faster. What makes me really surprised that continuously the business picks the first option - just add more mess to the existing one without thinking of the consequences.<br /><br />Now for the tricky part. Now change the word "business" to "developer" and everything is still valid.<br /><br />"Delivering a feature" it's not only coding some functions in whatever language you are using. It's not taking a keyboard and pressing the keys to make the functionality work. If this is your approach then you're a key tapper. Tapping keys to get things done.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-N9ueTp3dNhI/Vh6sGeO-OUI/AAAAAAABIMY/ZTgNPN9Pras/s1600/dunno.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="231" src="http://4.bp.blogspot.com/-N9ueTp3dNhI/Vh6sGeO-OUI/AAAAAAABIMY/ZTgNPN9Pras/s320/dunno.jpg" width="320" /></a></div><br /></div><div><br /></div><h4>Programming is more than tapping keys</h4><div><br />I hope that nobody feels offended by this term "key tapper". I'm not trying to be offensive - I'm just describing what I saw in my career. In my opinion there are a couple of different types of IT guys:<br /><br /><ul><li>there are people for whom programming is a passion. They put a lot of energy and effort to make things better</li><li>there are also IT guys for whom programming isn't a passion, but still put (sucessfully) &nbsp;a lot of energy and effort in order to make things better just because they want to be honest and valuable employees (thanks Michal Szostek)</li><li>there are people for whom programming is not a passion and they just come to work and tap the keys&nbsp;</li><li>there are others who would love to do stuff properly but the business is breathing at their necks to do stuff in a bad way because the "deadlines are coming".</li><li>there are positions where people last. They come and simulate work. They lie, talk a lot and delegate work so that there is some impression of progress</li></ul><br />Regardless of the position, if one doesn't focus on quality and just taps in the functionality then:&nbsp;</div><div><ul><li>even if he provides the business feature it might badly influence other people (introducing coupling between modules, breaking encapsulation etc.)</li><li>the functionality might be written in such a way that you will result in the global timeout of the whole system</li><li>you're not thinking about the company standards (<a href="http://www.slideshare.net/MarcinGrzejszczak/4financeit-microservices-092015-kaunas-jug/87?src=clipshare">passing of CorrelationID for instance</a>), that will break the approaches set in the company. This in effect will lead in increased time needed to provide support</li><li>writing the next functionality will take more time than the previous one</li></ul></div><div>Even though it seems to be common knowledge, you can far too often hear something like this:</div><blockquote class="tr_bq">I don't have time for this - it's not my problem. I've delivered my business feature and this is what I'm paid for. What you're referring to is not of my interest.</blockquote>Now imagine that you join a project which is full of such developers and you're asked to fix a bug:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-c6LCeYh8sHs/Vh7A-E-ZjaI/AAAAAAABIM0/gelqAg9YKU0/s1600/new_guy.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="http://2.bp.blogspot.com/-c6LCeYh8sHs/Vh7A-E-ZjaI/AAAAAAABIM0/gelqAg9YKU0/s400/new_guy.png" width="267" /></a></div><br /><h4>Technical changes are not bringing money</h4><div><br />We have to educate both the business and the developers: writing features and providing business value is actually a sum of a coded and tested functionality with technical advancement. What are those? Code refactoring, introduction of new approaches, migrations from one way of doing things in one way to another. For example:</div><div><ul><li>version control system (e.g. SVN to Git)</li><li>build system (e.g Maven to Gradle)</li><li>UI framework (e.g. Vaadin to AngularJS)</li><li>library versions (e.g. Spring 3.0 to Spring 4.0)</li><li>going from deployment to application servers to embedded servlet containers (e.g. Glassifsh to embedded JAR with Jetty)</li></ul></div><div>Why do we want these changes to happen? Because they ease our work and enforce standards. Why are standards important?<br /><br /><div style="text-align: center;"><i>"Pick a plug they said, it's gonna be easy, they said"</i></div><br /><div class="separator" style="clear: both; text-align: center;"></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-StjBYB5gZOE/Vh7DWYGKYLI/AAAAAAABINI/7027zJf7kN8/s1600/plugs.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="196" src="http://4.bp.blogspot.com/-StjBYB5gZOE/Vh7DWYGKYLI/AAAAAAABINI/7027zJf7kN8/s400/plugs.jpg" width="400" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">https://abdulinnewzealand.wordpress.com/2012/12/03/new-things-from-my-visit-to-new-zeland/</td></tr></tbody></table>If every team in the company uses different:<br /><br /><ul><li>libraries</li><li>approach to testing</li><li>approach to deployment</li><li>approach to running the application</li></ul><br />Then you can tell your business that they will pay A LOT of money for the support. The learning curve will be gigantic for the newcomers. But hey! It's better to code a new functionality in the meantime right?<br /><br />Seemingly all the developers would like to see the effect of those migrations and standardization. Everybody wants this to happen but who should actually do it? When asked about this you might hear:</div><blockquote class="tr_bq">I don't have time for this - it's not my problem. I've delivered my business feature and this is what I'm paid for. What you're referring to is not of my interest.</blockquote><div>How can we solve this?<br /><br /><b>Stupid idea</b><br /><br />Introduce the following flow of working in IT:</div><div><ul><li>the "coding team" writes a business feature and pushes it to master</li><li>the "clean code team" rewrites the code according to the clean code standards</li><li>the "technical team" introduces the technical standards for the written piece of code</li><li>the "migration team" migrates the code from one approach to another</li></ul><div>The outcome of the cooperation could look like this:</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-8PyO94v8WnQ/Vh7FQYoj_TI/AAAAAAABINU/NfuIHRnzdZQ/s1600/bathroom.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-8PyO94v8WnQ/Vh7FQYoj_TI/AAAAAAABINU/NfuIHRnzdZQ/s320/bathroom.jpg" width="247" /></a></div><div><br /></div><div><br /></div><div><b>Good idea</b><br /><br />Introduce... caring! Invest a lot of time and effort in educating business and developers that you have to take care of the code quality. Imagine where your company would be if every programmer would focus for 1 hour per day to manage the technical debt. If your managers don't understand the importance of clearing that debt, then you should consider changing jobs cause it's going to get worse with every single push to the repo.<br /><br /></div></div><h4>You are an engineer!</h4><div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-pGZjd5My6EU/Vh7LQrT18oI/AAAAAAABINg/ku5r63yr3oY/s1600/engineer.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://2.bp.blogspot.com/-pGZjd5My6EU/Vh7LQrT18oI/AAAAAAABINg/ku5r63yr3oY/s320/engineer.jpg" width="320" /></a></div><br />Developing a feature is not just typing in code that compiles and makes the tests pass. Maybe the constant breathing of the project manager on your neck made you forget about this but you are an engineer. Following <a href="https://en.wikipedia.org/wiki/Engineer">Wikipedia</a>:</div><blockquote class="tr_bq"><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">An&nbsp;</span><b style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">engineer</b><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;is a&nbsp;</span><a href="https://en.wikipedia.org/wiki/Profession" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Profession">professional</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;practitioner of&nbsp;</span><a href="https://en.wikipedia.org/wiki/Engineering" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Engineering">engineering</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">, concerned with applying&nbsp;</span><a class="mw-redirect" href="https://en.wikipedia.org/wiki/Scientific_knowledge" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Scientific knowledge">scientific knowledge</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">,&nbsp;</span><a href="https://en.wikipedia.org/wiki/Mathematics" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Mathematics">mathematics</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">, and&nbsp;</span><a href="https://en.wikipedia.org/wiki/Ingenuity" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Ingenuity">ingenuity</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;to develop solutions for technical, societal and commercial problems. Engineers design materials, structures, and systems while considering the limitations imposed by practicality, regulation, safety, and cost.</span><sup class="reference" id="cite_ref-bls_1-0" style="background-color: white; color: #252525; font-family: sans-serif; font-size: 11.2px; line-height: 1; unicode-bidi: -webkit-isolate;"><a href="https://en.wikipedia.org/wiki/Engineer#cite_note-bls-1" style="background: none; color: #0b0080; text-decoration: none; white-space: nowrap;">[1]</a></sup><sup class="reference" id="cite_ref-nspe_2-0" style="background-color: white; color: #252525; font-family: sans-serif; font-size: 11.2px; line-height: 1; unicode-bidi: -webkit-isolate;"><a href="https://en.wikipedia.org/wiki/Engineer#cite_note-nspe-2" style="background: none; color: #0b0080; text-decoration: none; white-space: nowrap;">[2]</a></sup><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;The word&nbsp;</span><i style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">engineer</i><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;is derived from the&nbsp;</span><a href="https://en.wikipedia.org/wiki/Latin" style="background: none rgb(255, 255, 255); color: #0b0080; font-family: sans-serif; font-size: 14px; line-height: 22.4px; text-decoration: none;" title="Latin">Latin</a><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;words&nbsp;</span><i style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">ingeniare</i><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">&nbsp;("to contrive, devise") and&nbsp;</span><i style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">ingenium</i><span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;">("cleverness").</span><sup class="reference" id="cite_ref-3" style="background-color: white; color: #252525; font-family: sans-serif; font-size: 11.2px; line-height: 1; unicode-bidi: -webkit-isolate;"><a href="https://en.wikipedia.org/wiki/Engineer#cite_note-3" style="background: none; color: #0b0080; text-decoration: none; white-space: nowrap;">[3]</a></sup><sup class="reference" id="cite_ref-4" style="background-color: white; color: #252525; font-family: sans-serif; font-size: 11.2px; line-height: 1; unicode-bidi: -webkit-isolate;"><a href="https://en.wikipedia.org/wiki/Engineer#cite_note-4" style="background: none; color: #0b0080; text-decoration: none; white-space: nowrap;">[4]</a></sup></blockquote><div>So other than telling one again:</div><blockquote class="tr_bq">I don't have time for this - it's not my problem. I've delivered my business feature and this is what I'm paid for. What you're referring to is not of my interest.</blockquote><div>you should consider all of the technical aspect before even writing a single line of code. Then you should say:</div><blockquote class="tr_bq">My schedule is tight but I'll fix the issues that you suggested. I understand that delivering business value means writing a feature and making the technical progress as a company. This is what I'm paid for and what you are referring to is part of my duties.&nbsp;</blockquote>Unfortunately there is one problem with this approach...<br /><br /><h4>Are you an engineer that has a say? You're gonna get fired!</h4><br />Yes, if you start caring in a corporate enterprise you will eventually get fired. Business prefers people who nod their heads and agree to everything. After some time quality becomes a burden for the management. It becomes a cost that doesn't bring "business value".<br /><br />So you will start fighting for the quality because this is the very meaning of your programming life. Deliver quality software that satisfies the business requirements, bearing in mind technical consequences. You will defend your developers against the growing pressure from the business to deliver features at a larger pace. The corporate axe will come closer to your neck with every single fight to defend the very meaning of being an engineer.<br /><br />In the meantime your fellow developers that don't agree with your permanent interference in the key tapping due to buzzwords like "resilience", "fail-fast", "latency" or "tests" will continue to dislike you. They will constantly show their lack of support to what you're doing. Their mediocrity and lack of willingness to stand to what they believe in will allow them to remain in the company for years to come.<br /><br />Then one day you will have to pack your stuff in a box and you will be escorted out of the office because you will get fired. The reason will be simple: "not delivering business value".<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-baNDD9nKPtQ/Vh7QTfvgBTI/AAAAAAABIN4/p1xdBPOtkrU/s1600/guillotine.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="230" src="http://4.bp.blogspot.com/-baNDD9nKPtQ/Vh7QTfvgBTI/AAAAAAABIN4/p1xdBPOtkrU/s320/guillotine.gif" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;">But... don't worry! That's actually good. Someone is doing you a favor! In the long run you will definitely profit from being fired. You will gain respect because you stood for your values. You will be able to stand in the mirror, look at yourself and say that you've done everything your power to do things properly with high quality.</div><div class="separator" style="clear: both; text-align: center;"><br /></div><h4>Epilogue</h4><div class="" style="clear: both; text-align: left;"><br /></div><div class="" style="clear: both; text-align: left;">Hopefully my apocalyptic vision is too harsh but that's what I see when talking to people in the industry. There is a light at the end of the tunnel though (and it's not a freight train).&nbsp;</div><div class="" style="clear: both; text-align: left;">There are companies that value good engineers and value quality. If you get fired (or you're getting close to that) just file a CV there. You can be shocked that the very sense of caring and eagerness to learn drastically boosts your chances of getting hired.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-oFjV8za2yWM/Vh7M1xlgLRI/AAAAAAABINs/_yxMM4Gp_Vw/s1600/the_end.gif" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="212" src="http://1.bp.blogspot.com/-oFjV8za2yWM/Vh7M1xlgLRI/AAAAAAABINs/_yxMM4Gp_Vw/s320/the_end.gif" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: left;"><br /></div><h4>Additional reading</h4><div class="" style="clear: both;"><br /><ul><li><a href="https://medium.com/@bryanedds/living-in-the-age-of-software-fuckery-8859f81ca877">Living in the age of software fuckery</a></li><li><a href="http://www.kalzumeus.com/2011/10/28/dont-call-yourself-a-programmer/">Don't call yourself a programmer</a></li></ul><br /><br /></div></div></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Microservice Deployment]]></title>
    <link href="http://toomuchcoding.com/blog/2015/09/27/microservice-deployment/"/>
    <updated>2015-09-27T00:13:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2015/09/27/microservice-deployment</id>
    <content type="html"><![CDATA[<div class='post'>
It's been a while since my last post. In the meantime of course nothing has changed in terms of the microservice hype. I've been &nbsp;attending many microservice's talks and what I'm always missing are concrete details on many different subjects. One of which is deployment. In this post I'll try to depict how in a big, multinational company one would want to do microservice deployment. I'll walk you through the most basic deployment pipeline that could be created in such an enterprise.<br /><br /><a name='more'></a>
<!--more-->
<br /><h4>The goal</h4>Our goal was to:<br /><br /><b>Enforce standards</b><br /><b><br /></b>Have a unique way of deploying alll microservices - we need to enforce standards<br /><br /><b>Tackle the microservice dependencies complexity issue</b><br /><br />Make the deployment process maintainable from the infrastructure and operations perspective<br /><br /><b>Make the pipeline fast and certain</b><br /><br />Have the greatest possible certainty that our features are working fine.<br />We wanted to make the deployment pipeline as fast as possible.<br />It was crucial to add the possibility to automatically rollback if something goes wrong.<br /><br /><h4>Enforce standards</h4>It is crucial that if you're starting with microservices you start introducing standards. Standards of running applications, configuring them (externalized properties) but also you should enforce standards in how you deploy your applications. At some point in time we have seen that different applications do common tasks in different ways.<br /><br />Why should we bother - we have business value to deliver and not waste time on enforcing standards - your manager might say. Actually he is really wrong because you're wasting plenty of time (thus money) on supporting such nonstandard applications. Imagine how much it needs for the new developers to understand how exactly the rules are set in this particular process.<br /><br />The same relates to deployment and deployment pipelines. That's why we decided to enforce one, single way of deploying microservices.<br /><br /><h4><span style="font-weight: normal;">Tackle the microservice dependencies complexity issue</span></h4><br />If you have two monolithic applications talking to each other and not too many developers working on the codebases you can queue deployment of both apps and always perform end to end tests.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-G80VsWKpIy0/VgbyR9nENVI/AAAAAAABII4/rYV8ZIMJi6A/s1600/monolith.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="124" src="https://2.bp.blogspot.com/-G80VsWKpIy0/VgbyR9nENVI/AAAAAAABII4/rYV8ZIMJi6A/s320/monolith.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Two monolithic applications deployed for end to end testing</td></tr></tbody></table><div class="separator" style="clear: both; text-align: left;">In case of microservices the scale starts to be a problem:</div><div class="separator" style="clear: both; text-align: left;"><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-kggPwWHR-iQ/VgbyhX1x5aI/AAAAAAABIJA/tf2lLkCruxA/s1600/many_microservices.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="207" src="https://2.bp.blogspot.com/-kggPwWHR-iQ/VgbyhX1x5aI/AAAAAAABIJA/tf2lLkCruxA/s320/many_microservices.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Many microservices deployed in different versions</td></tr></tbody></table><div class="separator" style="clear: both; text-align: left;">The questions arise:</div><div class="separator" style="clear: both; text-align: left;"></div><ul><li>Should I queue deployments of microservices on one testing environment or should I have an environment per microservice?&nbsp;</li><ul><li>If I queue deployments people will have to wait for hours to have their tests ran - that can be a problem</li></ul><li>To remove that issue I can have an environment per microservice&nbsp;</li><ul><li>Who will pay the bills (imagine 100 microservices - each having each own environment).&nbsp;</li><li>Who will support each of those environments?</li><li>Should we spawn a new environment each time we execute a new pipeline and then wrap it up or should we have them up and running for the whole day?</li></ul><li>In which versions should I deploy the dependent microservices - development or production versions?</li><ul><li>If I have development versions then I can test my application against a feature that is not yet on production. That can lead to exceptions on production</li><li>If I test against production versions then I'll never be able to test against a feature under development anytime before deployment to production.</li></ul></ul><h4>Make the pipeline fast and certain</h4><div><br /></div><div>Since we really believe in the agile methodology and continuous deployment we would like our features to be delivered to production as fast as possible. When working with the monolithic applications we've faced the following issues:</div><div><ul><li>For monolithic applications we had plenty of unit, integration and end to end tests</li><li>The different types of tests covered the same functionality up to three times</li><li>The tests took a lot of time to run</li></ul><div>Having all of this in mind we wanted not to have such issues with our new deployment pipeline.</div><div><br /></div></div><br /><div class="separator" style="clear: both; text-align: left;"></div><h4>Simplify the infrastructure complexity</h4><div><br /></div><div>Due to technical issues, difficulties to maintain the spawned environments we've decided to simplify the pipeline as much as possible. That's why since we are enthusiasts of TDD and we know what Consumer Driven Contract is we've decided not to do End to End tests. We're deploying our application to a virtual machine where the executed tests don't interfere with other pipelines executed in the very same time.</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-3BIKN1VzDKA/Vgb7oxk8jXI/AAAAAAABIJQ/q_A0LifBgEI/s1600/stubbed_dependencies.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="203" src="https://3.bp.blogspot.com/-3BIKN1VzDKA/Vgb7oxk8jXI/AAAAAAABIJQ/q_A0LifBgEI/s320/stubbed_dependencies.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Execute tests on a deployed microservice on stubbed dependencies</td></tr></tbody></table><div>That way you can look at your application tests (we called them smoke tests) in the following way:</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-7jseO68-q6A/Vgb8h7Ia1CI/AAAAAAABIJc/C8W0S4qZAic/s1600/no_e2e_tests.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="303" src="https://3.bp.blogspot.com/-7jseO68-q6A/Vgb8h7Ia1CI/AAAAAAABIJc/C8W0S4qZAic/s320/no_e2e_tests.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">We're testing microservices in isolation</td></tr></tbody></table><div>Why smoke tests? Because we deliberately want to enforce the testing pyramid in the following way:</div><div><ul><li>A lot of unit tests executed during build time</li><li>Some integration tests running on stubs of dependent services executed during build time</li><li>Not many acceptance tests&nbsp;running on stubs of dependent services executed during build time (these can be treated as special case of integration tests)</li><li>A handful of smoke tests executed on a deployed application to see if the app is really packaged properly</li></ul></div><div><br /></div><div>Such an approach to testing and deployment gives the following benefits:</div><div><ul><li>No need to deploy dependent services</li><li>The stubs used for the tests ran on a deployed microservice are the same as those used during integration tests</li><li>Those stubs have been tested against the application that produces them (check <a href="https://github.com/Codearte/accurest">Accurest</a> for more information)</li><li>We don't have many slow tests running on a deployed application - thus the pipeline gets executed much faster</li><li>We don't have to queue deployments - we're testing in isolation thus pipelines don't interfere with each other</li><li>We don't have to spawn virtual machines each time for deployment purposes</li></ul></div><div><br /></div><div>It brings however the following challenges:</div><div><ul><li>No end to end tests before production - you don't have the full certainty that a feature is working</li><li>Due to this certainty that the functionality is working decreases</li><li>First time the applications will talk in a real way will be on production</li></ul></div><h4>Overcoming fear of uncertainty</h4><div><br /></div><div>The argument that we don't know if a functionality is working properly made us invest more time and effort in tools that will give us more information on how our applications work on production. That's why we've added plenty of monitoring both technical and business via Graphite. Also we've introduced Seyren as the alerting mechanism to ping us immediately when something is really wrong on production.</div><div><br /></div><div>Whatever time you spend on improving your tests, testing environments or UATs with endless hours of clicking - it will never signify that on production your application will run in the same manner.</div><div><br /></div><div>Our decisions were related to trade offs. We decided to give away the complexity in the artificial test environments. That complexity was pushed to the monitoring of production instances. With microservices there is never an easy decision - there's always some price needed to pay.</div><div><br /></div><h4>The technical overview of the solution</h4><div><br /></div><div>We've divided the simplest scenario of the microservice deployment pipeline into the following steps.</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-JmkGUgmrI8Q/Vgb-y9Eg9RI/AAAAAAABIJo/QMa0rkaSfUk/s1600/Microservice%2BPipeline.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="305" src="https://4.bp.blogspot.com/-JmkGUgmrI8Q/Vgb-y9Eg9RI/AAAAAAABIJo/QMa0rkaSfUk/s640/Microservice%2BPipeline.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Microservice deployment pipeline (without A/B testing)</td></tr></tbody></table><div><b><u>Build the app (after commit)</u></b></div><div><br /></div><div>Most preferably we would like after each merge of a PR trigger the deployment pipeline (thus do Continuous Deployment).&nbsp;</div><div><br /></div><div>The result of this step would be to have the application tested in the following ways:</div><div><ul><li>unit and integration tests are ran</li><li>validity of declared stubs specifications is tested against the application itself</li></ul></div><div>Finally what is published to Nexus is the fat-jar of the application together with its stubs.&nbsp;</div><div><br /></div><div><b><u>Deploy to staging</u></b></div><div><br /></div><div>We deploy our freshly built application to the staging environment. <a href="https://github.com/4finance/micro-infra-spring/wiki/Stub-runner">Micro Infra Spring Stub-runner</a> is responsible for downloading the current <b>development</b>&nbsp;versions of stubs of declared dependencies of the microservice.&nbsp;</div><div><br /></div><div>In the first version of the pipeline we've decided to go towards development versions since we would like each of the applications to go live after each commit. That means that there is a high probability that the development version of a stub is in fact the production one. Of course that not necessarily needs to be true - but this is our trade off.</div><div><br /></div><div>In the future versions of the pipeline we would like to test the app against both development and production versions of stubs.&nbsp;</div><div><br /></div><div><b>What is very important to see is that in this step we are upgrading the microservice's DB schema.</b></div><div><b><br /></b></div><div><b><u>Test application rollback scenario</u></b></div><div><br /></div><div>We don't want to rollback the database. If you have MongoDB like databases there is no schema in fact. If you have Liquibase - you can provide the rollback scripts for relational DBs. They however introduce complexity on the DB level.</div><div><br /></div><div>We've decided to go with a trade off that the complexity goes out from the DB level to the code. We're not rolling back the DB but we're rolling back the application. That means that the developers need to write their code to support backwards compatibility.&nbsp;</div><div><br /></div><div><b>That means that the NEW version of the application MUST support the OLD schema of the database. Also developers MUST NOT do backwards incompatible changes in subsequent liquibase scripts.</b></div><div><b><br /></b></div><div>We're running old smoke tests on the rolled back version of the application that is connected to the new version of the schema. That way we can ensure that most probably we will be able to rollback on production without greater issues.</div><div><br /></div><div><b><u>Deploy to production</u></b></div><div><br /></div><div>If the smoke tests have passed and we've checked the rollback procedures we can go live. Here the monitoring part comes in. We need to ensure that we've put all the KPI checking alerts in place. As a part of deployment procedure a review of monitoring and alerts needs to take place.</div><div><br /></div><div>As you can see in the picture the first scenario of live deployment doesn't include 0 downtime approach. That was yet another trade off that we've decided to take. We don't want to tackle the issue of automatic data migration right now. Also for the developers writing code that supports both old and new schema is actually mind blowing. That's why we want to do things a step at a time - for now we kill all the application instances on production, boot one up and &nbsp;change the schema and then boot the rest up too.</div><div><br /></div><br /><div class="separator" style="clear: both; text-align: left;"><b><u>Rollback procedure</u></b></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">If our KPI monitoring starts to go all red on production then we need to rollback as fast as possible. Since we've tested the rollback procedure it shouldn't be an issue on production to kill all the instances, download the previous version of the app and run it against the new schema.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><h4 style="clear: both; text-align: left;">Summary</h4><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">As everything related to distributed systems - you can see that microservice deployment is not easy. Actually it's full of trade offs and complexity. Starting from the infrastructure going through testing and finishing with database schema changes.</div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;">The presented solution seems to be an acceptable compromise between time, effort, certainty and feedback.</div></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to speed up your Gradle build from 90 to 8 minutes]]></title>
    <link href="http://toomuchcoding.com/blog/2015/02/08/how-to-speed-up-your-gradle-build-from/"/>
    <updated>2015-02-08T19:24:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2015/02/08/how-to-speed-up-your-gradle-build-from</id>
    <content type="html"><![CDATA[<div class='post'>
<div style="background-color: white; box-sizing: border-box; color: #262626; font-family: Georgia, serif; font-size: 19px; line-height: 27.55px;">Even though I was supposed to write a series of blog posts about&nbsp;<a href="http://toomuchcoding.blogspot.com/search/label/micro-infra-spring" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">micro-infra-spring</a>&nbsp;here at&nbsp;<a href="http://toomuchcoding.blogspot.com/" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Too Much Coding blog</a>, today I'll write about how we've managed to decrease our biggest project's build time from 90 to 8 minutes!<br /><br /><a name='more'></a>
<!--more-->
  <br style="box-sizing: border-box;" /><br /><br style="box-sizing: border-box;" />At one of the companies that I've been working we've faced a big problem related to pull request build times. We have one monolithic application that we are in progress of slicing into microservices but still until this process is finished we have to build that big app for each PR. We needed to change things to have really fast feedback from our build so that pull request builds don't get queued up endlessly in our CI. You can only imagine the frustration of developers who can't have their branches merged to master because of the waiting time.<br /><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Structure</strong></div>In that project we have over 200 Gradle modules and over a dozen big projects (countries) from which we can build some (really fat) fat-jars. We have also a core module that if we change then we would have to rebuild all the big projects to check if they weren't affected by the modifications. There are a few old countries that are using GWT compilers and we have some JS tasks executed too.<br /><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Initial stats</strong></div>Before we started to work on optimization of the process the whole application (all the countries) was built in about 1h 30 minutes.<br /><br style="box-sizing: border-box;" /><i style="box-sizing: border-box;">Current build time: ~90 minutes.</i></div><div style="background-color: white; box-sizing: border-box; color: #262626; font-family: Georgia, serif; font-size: 19px; line-height: 27.55px;"><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Profile your build</strong></div>First thing that we've done was to run the build with the&nbsp;--profile&nbsp;switch.<br /><br style="box-sizing: border-box;" />That way Gradle created awesome stats for our build. If you are doing any sort of optimization then it's crucial to gather measurements and statistics. Check out this&nbsp;<a href="https://gradle.org/docs/current/userguide/tutorial_gradle_command_line.html#sec:profiling_build" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Gradle page about profiling your build&nbsp;</a>for more info on that switch and features.</div><div style="background-color: white; box-sizing: border-box; color: #262626; font-family: Georgia, serif; font-size: 19px; line-height: 27.55px;"><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Exclude long running tasks in dev mode</strong></div><div style="box-sizing: border-box;"><span data-fr-verified="true" style="background-color: initial; box-sizing: border-box;"><span data-fr-verified="true" style="box-sizing: border-box; line-height: 1.45em;"><span data-fr-verified="true" style="box-sizing: border-box; font-size: 15px;"><span data-fr-verified="true" style="box-sizing: border-box; font-family: &quot;arial&quot; , &quot;helvetica&quot; , &quot;verdana&quot; , &quot;tahoma&quot; , sans-serif;">It turned out that we are spending a lot of time on JS minification and on GWT compilation. That's why we have added a custom property&nbsp;-PdevMode&nbsp;to disable some long running tasks in dev mode build. Those tasks were:</span></span></span></span></div><br style="box-sizing: border-box;" /><ul style="box-sizing: border-box; margin-bottom: 10px; margin-top: 0px; padding-left: 25px;"><li style="box-sizing: border-box; padding: 0px 0px 8px;">excluded JS minification</li><ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding-left: 25px;"><li style="box-sizing: border-box; padding: 0px 0px 8px;">benefit: 13 countries * ~60 secs * at least 2 modules where minification occurred ~ 26 minutes</li></ul><li style="box-sizing: border-box; padding: 0px 0px 8px;">optimized GWT compilation:&nbsp;</li><ul style="box-sizing: border-box; margin-bottom: 0px; margin-top: 0px; padding-left: 25px;"><li style="box-sizing: border-box; padding: 0px 0px 8px;">have permutations done for only 1 browser (by default it's done for multiple browsers)</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">disable optimization of the compilation (-optimize 0)</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">add the -draftCompile switch to to compile quickly with minimal optimizations</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">benefit: about 2 minutes less on GWT compilation * sth like 5 projects with GWT ~ 10 minutes</li></ul></ul><i style="box-sizing: border-box;">Overall gain: ~ 40 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~50 minutes.</em></div><div style="box-sizing: border-box;"><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Check out your tests</strong></div>Together with the one and only&nbsp;<a href="http://github.com/achudzik" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Adam Chudzik</a>&nbsp;we have started to write our own&nbsp;<a href="https://github.com/marcingrzejszczak/gradle-test-profiler" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Gradle Test Profiler</a>&nbsp;(it's a super beta version ;) ) that created a single CSV with sorted tests by their execution time. We needed quick and easy gains without endless test refactoring and it turned out that it's really simple. One of our tests took 50 seconds to execute and it was testing a feature that has and will never be turned on on production. Of course there were plenty of other tests that we should take a look into (we'd have to look for test duplication, check out the test setup etc.) but it would involve more time, help of a QA and we needed quick gains.<br /><br style="box-sizing: border-box;" />Benefit: By simple disabling this test we gained about 1 minute.<br /><i style="box-sizing: border-box;">Overall gain: ~ 41 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~49 minutes.</em></div><div style="box-sizing: border-box;"><br style="box-sizing: border-box;" /></div><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Turn on the --parallel Gradle flag at least for the compilation</strong></div>Even though at this point our gains were more or less 40 minutes it was still unacceptable for us to wait 40 minutes for the pull request to be built.<br /><br style="box-sizing: border-box;" />That's why we decided to go parallel! Let's build the projects (over 200) in parallel and we'll gain a lot of time on that. When you execute the Gradle build with the --parallel flag Gradle calculates how many threads can be used to concurrently build the modules. For more info go to the&nbsp;<a href="https://gradle.org/docs/current/userguide/multi_project_builds.html#sec:parallel_execution" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Gradle's documentation on parallel project execution</a>.<br /><br style="box-sizing: border-box;" />It's an incubating feature so wen we started to get&nbsp;BindExceptions&nbsp;on port allocation we initially thought that most likely it's Gradle's fault. Then we had a chat with&nbsp;<a href="https://twitter.com/szczepiq" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">Szczepan Faber</a>who worked for Gradleware and it turns out that the feature is actually really mature (thx Szczepan for the help BTW :) ).<br /><br style="box-sizing: border-box;" />We needed quick gains so instead of fixing the port binding stuff we decided only to compile everything in parallel and then run tests sequentially.</div><div style="box-sizing: border-box;"><br />Benefit: By doing this lame looking hack we gained ~4 mintues (on my 8 core laptop).<br /><i style="box-sizing: border-box;">Overall gain: ~ 45 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~45 minutes.</em></div><div style="box-sizing: border-box;"><br style="box-sizing: border-box;" /></div><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Don't be a jerk - just prepare your tests for parallelization</strong></div>This command seemed so lame that we couldn't even look at it. That's why we said - let's not be jerks and just fix the port issues.<br /><br style="box-sizing: border-box;" />So we went through the code, randomized all the fixed ports, patched&nbsp;<a href="http://github.com/4finance/micro-infra-spring" style="background: transparent; box-sizing: border-box; color: black; cursor: pointer; text-decoration: none;">micro-infra-spring</a>&nbsp;so it does the same upon Wiremock and Zookeeper instantiation and just ran the building of the project like this:<br /><br style="box-sizing: border-box;" />We were sure that this is the killer feature that we were lacking and we're going to win the lottery. Much to our surprise the result was really disappointing.<br /><br style="box-sizing: border-box;" />Benefit: Concurrent project build decreased the time by ~5 minutes.<br /><i style="box-sizing: border-box;">Overall gain: ~ 50 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~40 minutes.</em></div><div style="box-sizing: border-box;"><br style="box-sizing: border-box;" /></div><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Check out your project structure</strong></div>You can only imagine the number of WTFs that were there in our office. How on earth is that possible?<br /><br style="box-sizing: border-box;" />We've opened up&nbsp;htop,&nbsp;iotop&nbsp;and all the possible tools including&nbsp;vmstat&nbsp; to see what the hell was going on. It turned out that context switching is at an acceptable level whereas at some point of the build only part of the cores are used as if sth was executed sequentially!<br /><br style="box-sizing: border-box;" />The answer to that mystery was pretty simple. We had a wrong project structure.<br /><br style="box-sizing: border-box;" />We had a module that ended up as a test-jar in&nbsp;testCompile&nbsp;dependency of other projects. That means that the vast majority of modules where waiting for this project to be built. Built means compiled and tested. It turned out that this test-jar module had also plenty of slow integration tests in it so only after those tests were executed could other modules be actually built!<br /><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Simple source moving can drastically increase your speed</strong></div>By simply moving those slow tests to a separate module we've unblocked the build of all modules that were previously waiting.<br /><br style="box-sizing: border-box;" />Now we could do further optimization - we've split the slow integration tests into two modules to make all the modules in the whole project be built in more or less equal time (around 3,5 minutes).<br />.<br />Benefit: Fixing the project structure decreased the time by ~10 minutes<br /><i style="box-sizing: border-box;">Overall gain: ~ 60 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~30 minutes.</em></div><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Don't save on machine power</strong></div><div style="box-sizing: border-box;"><span data-fr-verified="true" style="background-color: initial; box-sizing: border-box;"><span data-fr-verified="true" style="box-sizing: border-box; line-height: 1.45em;"><span data-fr-verified="true" style="box-sizing: border-box; font-size: 15px;"><span data-fr-verified="true" style="box-sizing: border-box; font-family: &quot;arial&quot; , &quot;helvetica&quot; , &quot;verdana&quot; , &quot;tahoma&quot; , sans-serif;">We've invested in some big AWS instance with 32 cores and 60 gb of RAM to really profit from the parallel build's possibilities. We're paying about 1.68$ per one hour of such machine's (c3.8xlarge) working time.</span></span></span></span></div><br style="box-sizing: border-box;" />If someone form the management tells you that that machine costs a lot of money and the company can't afford it you can actually do a fast calculation. You can ask this manager what is more expensive - paying for the machine or paying the developer for 77 minutes * number of builds of waiting?<br /><br style="box-sizing: border-box;" />Benefit: Paying for a really good machine on AWS decreased the build time by ~22 minutes<br /><i style="box-sizing: border-box;">Overall gain: ~ 82 minutes.</i><br /><div style="box-sizing: border-box;"><em style="box-sizing: border-box;">Current build time: ~8 minutes.</em></div><div style="box-sizing: border-box;"><br style="box-sizing: border-box;" /></div><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">What else can we do?</strong></div>Is that it? Can we decrease the time further on? Sure we can!<br /><br style="box-sizing: border-box;" />Possible solutions are:<br /><br style="box-sizing: border-box;" /><ul style="box-sizing: border-box; margin-bottom: 10px; margin-top: 0px; padding-left: 25px;"><li style="box-sizing: border-box; padding: 0px 0px 8px;">Go through all of the tests and check why some of them take so long to run</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">Go through the integration tests and check if don't duplicate the logic - we will remove them</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">We're using Liquibase for schema versioning and we haven't merged the changests for some time thus sth like 100 changesets are executed each time we boot up Spring context (it takes more or less 30 seconds)</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">We could limit the Spring context scope for different parts of our applications so that Spring boots up faster</li><li style="box-sizing: border-box; padding: 0px 0px 8px;">Buy a more powerful machine ;)</li></ul><div style="box-sizing: border-box;">There is also another, better way ;)</div><div style="box-sizing: border-box;">SPLIT THE MONOLITH INTO MICROSERVICES AND GO TO PRODUCTION IN 5 MINUTES ;)</div><br style="box-sizing: border-box;" /><div style="box-sizing: border-box; margin-bottom: 15px; margin-top: 5px;"><strong style="box-sizing: border-box;">Summary</strong></div>Hopefully I've managed to show you how you can really speed up your build process. The work to be done is difficult, sometimes really frustrating but as you can see very fruitful.</div></div></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spock Subject Collaborators Extension 1.0.1 released!]]></title>
    <link href="http://toomuchcoding.com/blog/2014/12/17/spock-subject-collaborators-extension/"/>
    <updated>2014-12-17T23:28:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2014/12/17/spock-subject-collaborators-extension</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />I'm really happy to say that I've just released a new version 1.0.1 of the <a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension">Spock Subject Collaborators Extension</a>.<br /><br />The changelog is as follows:<br /><br /><a name='more'></a><br />
<!--more-->
<h2 style="border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 0px !important; padding-bottom: 0.3em; position: relative;"><a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/tree/1.0.1" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; box-sizing: border-box; color: #4183c4; text-decoration: none;">1.0.1</a></h2><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">Bug fixes:</div><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;"><a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/issues/3" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; box-sizing: border-box; color: #4183c4; text-decoration: none;">#3</a>&nbsp;Make plugin compatible with Spock 1.0.0-SNAPSHOT</div><h2 style="border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em; position: relative;"><a aria-hidden="true" class="anchor" href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/blob/master/CHANGELOG.md#100" id="user-content-100" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; bottom: 0px; box-sizing: border-box; color: #4183c4; display: block; left: 0px; margin-left: -30px; padding-left: 30px; padding-right: 6px; position: absolute; text-decoration: none; top: 0px;"></a><a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/tree/1.0.0" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; box-sizing: border-box; color: #4183c4; text-decoration: none;">1.0.0</a></h2><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">New features:</div><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px;"><a href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/issues/1" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; box-sizing: border-box; color: #4183c4; text-decoration: none;">#1</a>&nbsp;Inject superclass fields - now you can inject fields to your superclass</div><br />As you can see now you'll be able to use this extension together with Spock in version 1.0.0 (assuming that nothing will change until then).<br /><br /><h2>How to get it?</h2><h3 style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 1.5em; line-height: 1.43; margin-bottom: 16px; margin-top: 1em; position: relative;">For Maven:</h3><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">Add JCenter repository:</div><div class="highlight highlight-xml" style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;"><pre style="background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; font-stretch: normal; line-height: 1.45; overflow: auto; padding: 16px; word-break: normal; word-wrap: normal;">&lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">repositories</span>&gt;<br />    &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">repository</span>&gt;<br />        &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">snapshots</span>&gt;<br />            &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">enabled</span>&gt;false&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">enabled</span>&gt;<br />        &lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">snapshots</span>&gt;<br />        &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">id</span>&gt;central&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">id</span>&gt;<br />        &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">name</span>&gt;bintray&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">name</span>&gt;<br />        &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">url</span>&gt;http://jcenter.bintray.com&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">url</span>&gt;<br />    &lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">repository</span>&gt;<br />&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">repositories</span>&gt;</pre></div><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">Add dependency:</div><div class="highlight highlight-xml" style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;"><pre style="background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; font-stretch: normal; line-height: 1.45; overflow: auto; padding: 16px; word-break: normal; word-wrap: normal;">&lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">dependency</span>&gt;<br />      &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">groupId</span>&gt;com.blogspot.toomuchcoding&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">groupId</span>&gt;<br />      &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">artifactId</span>&gt;spock-subjects-collaborators-extension&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">artifactId</span>&gt;<br />      &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">version</span>&gt;1.0.1&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">version</span>&gt;<br />      &lt;<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">scope</span>&gt;test&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">scope</span>&gt;<br />&lt;/<span class="pl-ent" style="box-sizing: border-box; color: #63a35c;">dependency</span>&gt;</pre></div><h3 style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 1.5em; line-height: 1.43; margin-bottom: 16px; margin-top: 1em; position: relative;"><a aria-hidden="true" class="anchor" href="https://github.com/marcingrzejszczak/spock-subjects-collaborators-extension/blob/master/README.md#for-gradle" id="user-content-for-gradle" style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; bottom: 0px; box-sizing: border-box; color: #4183c4; display: block; left: 0px; margin-left: -30px; padding-left: 30px; padding-right: 6px; position: absolute; text-decoration: none; top: 0px;"></a>For Gradle:</h3><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">Add JCenter repository:</div><div class="highlight highlight-gradle" style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;"><pre style="background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; font-stretch: normal; line-height: 1.45; overflow: auto; padding: 16px; word-break: normal; word-wrap: normal;"><span class="pl-en" style="box-sizing: border-box; color: #795da3;">repositories</span> {<br />    jcenter()<br />}</pre></div><div style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;">Add dependency:</div><div class="highlight highlight-gradle" style="box-sizing: border-box; color: #333333; font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; font-size: 16px; line-height: 25.6000003814697px; margin-bottom: 16px;"><pre style="background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; font-stretch: normal; line-height: 1.45; overflow: auto; padding: 16px; word-break: normal; word-wrap: normal;"><span class="pl-en" style="box-sizing: border-box; color: #795da3;">dependencies</span> {<br />    testCompile <span class="pl-s1" style="box-sizing: border-box; color: #df5000;"><span class="pl-pds" style="box-sizing: border-box;">'</span>com.blogspot.toomuchcoding:spock-subjects-collaborators-extension:1.0.1<span class="pl-pds" style="box-sizing: border-box;">'</span></span><br />}</pre></div><br /><h2>How to use it?</h2><div>Below you have an example of usage:</div><div><br /></div><div><pre style="background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; font-stretch: normal; line-height: 1.45; overflow: auto; padding: 16px; word-break: normal; word-wrap: normal;"><span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">package</span> <span class="pl-smp" style="box-sizing: border-box;">com.blogspot.toomuchcoding.spock.subjcollabs</span><br /><br /><span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">import</span> <span class="pl-smi" style="box-sizing: border-box;">spock.lang.Specification</span><br /><span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">import</span> <span class="pl-smi" style="box-sizing: border-box;">com.blogspot.toomuchcoding.spock.subjcollabs.Collaborator</span><br /><span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">import</span> <span class="pl-smi" style="box-sizing: border-box;">com.blogspot.toomuchcoding.spock.subjcollabs.Subject</span><br /><br /><span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">class</span> <span class="pl-en" style="box-sizing: border-box; color: #795da3;">ConstructorInjectionSpec</span> <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">extends</span> <span class="pl-e" style="box-sizing: border-box; color: #795da3;">Specification</span> {<br /><br />    <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">public</span> <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">static</span> <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">final</span> <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">String</span> <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">TEST_METHOD_1</span> <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">=</span> <span class="pl-s1" style="box-sizing: border-box; color: #df5000;"><span class="pl-pds" style="box-sizing: border-box;">"</span>Test method 1<span class="pl-pds" style="box-sizing: border-box;">"</span></span><br /><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">SomeOtherClass</span> someOtherClassNotToBeInjected <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">=</span> <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">Mock</span>()<br /><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">@Collaborator</span><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">SomeOtherClass</span> someOtherClass <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">=</span> <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">Mock</span>()<br /><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">@Subject</span><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">SomeClass</span> systemUnderTest<br /><br />    <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">def</span> <span class="pl-s1" style="box-sizing: border-box; color: #df5000;"><span class="pl-pds" style="box-sizing: border-box;">"</span>should inject collaborator into subject<span class="pl-pds" style="box-sizing: border-box;">"</span></span>() {<br />        <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">given</span>:<br />            someOtherClass<span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">.</span>someMethod() <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">&gt;&gt;</span> <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">TEST_METHOD_1</span><br /><br />        <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">when</span>:<br />            <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">String</span> firstResult <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">=</span> systemUnderTest<span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">.</span>someOtherClass<span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">.</span>someMethod()<br /><br />        <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">then</span>:<br />            firstResult <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">==</span> <span class="pl-c1" style="box-sizing: border-box; color: #0086b3;">TEST_METHOD_1</span><br />            systemUnderTest<span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">.</span>someOtherClass <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">==</span> someOtherClass<br />    }<br /><br /><br />    <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">class</span> <span class="pl-en" style="box-sizing: border-box; color: #795da3;">SomeClass</span> {<br />        <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">SomeOtherClass</span> someOtherClass<br /><br />        <span class="pl-en" style="box-sizing: border-box; color: #795da3;">SomeClass</span>(<span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">SomeOtherClass</span> <span class="pl-v" style="box-sizing: border-box; color: #df5000;">someOtherClass</span>) {<br />            <span class="pl-v" style="box-sizing: border-box; color: #df5000;">this</span><span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">.</span>someOtherClass <span class="pl-k" style="box-sizing: border-box; color: #a71d5d;">=</span> someOtherClass<br />        }<br />    }<br /><br />    <span class="pl-s" style="box-sizing: border-box; color: #a71d5d;">class</span> <span class="pl-en" style="box-sizing: border-box; color: #795da3;">SomeOtherClass</span> {<br />        <span class="pl-st" style="box-sizing: border-box; color: #a71d5d;">String</span> <span class="pl-en" style="box-sizing: border-box; color: #795da3;">someMethod</span>() {<br />            <span class="pl-s1" style="box-sizing: border-box; color: #df5000;"><span class="pl-pds" style="box-sizing: border-box;">"</span>Some other class<span class="pl-pds" style="box-sizing: border-box;">"</span></span><br />        }<br />    }<br /><br />}</pre></div><h2>Disclaimer</h2>Remember that if you're using this extension as a way to hack your way through an awful design of your application then you should do your best to fix your code in the first place! You've been warned ;)</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New personal website]]></title>
    <link href="http://toomuchcoding.com/blog/2014/10/27/new-personal-website/"/>
    <updated>2014-10-27T22:39:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2014/10/27/new-personal-website</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />I've just changed my website so feel free to check it out :) <a href="http://www.marcin.grzejszczak.pl/">http://www.marcin.grzejszczak.pl/</a></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mockito Cookbook is out!!]]></title>
    <link href="http://toomuchcoding.com/blog/2014/06/25/mockito-cookbook-is-out/"/>
    <updated>2014-06-25T19:34:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2014/06/25/mockito-cookbook-is-out</id>
    <content type="html"><![CDATA[<div class='post'>
<br />I'm very pleased to announce that you can order my new book<a href="https://www.packtpub.com/mockito-cookbook/book"> Mockito Cookbook</a> here <a href="https://www.packtpub.com/mockito-cookbook/book">https://www.packtpub.com/mockito-cookbook/book</a> . I hope that you will enjoy it :)</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Pre-order Mockito Cookbook!!]]></title>
    <link href="http://toomuchcoding.com/blog/2014/06/12/pre-order-mockito-cookbook/"/>
    <updated>2014-06-12T23:15:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2014/06/12/pre-order-mockito-cookbook</id>
    <content type="html"><![CDATA[<div class='post'>
<br />Hi!<br /><br />I'm pleased to announce that you can already pre-order my new book <a href="https://www.packtpub.com/mockito-cookbook/book">Mockito Cookbook</a>. You can buy it on <a href="https://www.packtpub.com/mockito-cookbook/book">Packt Publishing's website</a>. The whole code from the book + plenty of extras are available at <a href="https://github.com/marcingrzejszczak/mockito-cookbook">Github over here</a>. Enjoy :)</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mockito Instant Code Repo at Github]]></title>
    <link href="http://toomuchcoding.com/blog/2014/06/04/mockito-instant-code-repo-at-github/"/>
    <updated>2014-06-04T20:57:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2014/06/04/mockito-instant-code-repo-at-github</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />Since I was asked for the code to the<a href="http://www.packtpub.com/how-to-create-stubs-mocks-spies-using-mockito/book"> "Mockito Instant"</a> book a couple of times I decided to place it on Github. Here is the link - <a href="https://github.com/marcingrzejszczak/mockito-instant">https://github.com/marcingrzejszczak/mockito-instant</a>. Enjoy :)</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Groovy Builder AST merged to Groovy Core!]]></title>
    <link href="http://toomuchcoding.com/blog/2014/04/24/groovy-builder-ast-merged-to-groovy-core/"/>
    <updated>2014-04-24T17:34:00+02:00</updated>
    <id>http://toomuchcoding.com/blog/2014/04/24/groovy-builder-ast-merged-to-groovy-core</id>
    <content type="html"><![CDATA[<div class='post'>
<p dir=ltr>Hi! </p><p dir=ltr>Today it turned out that Paul King merged the Builder AST transform that based on my <a href="https://github.com/groovy/groovy-core/pull/341">PojoBuilder</a> to core of Groovy. So you will be able to use it when the new version of Groovy gets released.</p><p dir=ltr>You can take a look at the code here</p><p dir=ltr><a href="https://github.com/groovy/groovy-core/pull/389">https://github.com/groovy/groovy-core/pull/389</a></p><p dir=ltr>Many thanks go to <a href="http://solidsoft.wordpress.com"><b>Marcin Zaj&#261;czkowski</b></a> for his code review to the initial version.</p><p dir=ltr>It's not the biggest features in the world but anyway, enjoy :)</p></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Warsaw Groovy User Group Talk - AST Transformations]]></title>
    <link href="http://toomuchcoding.com/blog/2014/03/21/warsaw-groovy-user-group-talk-ast/"/>
    <updated>2014-03-21T09:19:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2014/03/21/warsaw-groovy-user-group-talk-ast</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br /><a href="http://www.youtube.com/watch?v=JdSCDEkX0Tw">Click here to go to the on-air hangout (in PL) regarding AST Transformations from my yesterday's presentation on Warsaw Groovy User Group</a></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Warsaw Groovy User Group talk]]></title>
    <link href="http://toomuchcoding.com/blog/2014/02/19/warsaw-groovy-user-group-talk/"/>
    <updated>2014-02-19T23:39:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2014/02/19/warsaw-groovy-user-group-talk</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />Since tomorrow I'm giving a talk on XML transformations in Groovy I'd like to publish the code that will be presented during the presentation. Check out the <a href="https://github.com/marcingrzejszczak/groovy-xml">Github repo</a>&nbsp;and the <a href="https://bitbucket.org/gregorin1987/groovy-xml">Bitbucket repository</a>.<br /><br />The presentation (in polish) can be found on <a href="https://www.youtube.com/watch?feature=player_detailpage&amp;v=MGu0HHzROxA#t=2109">youtube</a>.</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introduction to Groovy runtime metaprogramming and AST transforms]]></title>
    <link href="http://toomuchcoding.com/blog/2014/02/04/introduction-to-groovy-runtime/"/>
    <updated>2014-02-04T23:50:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2014/02/04/introduction-to-groovy-runtime</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />I'm very happy to share my presentation regarding <b><i>Groovy metaprogramming and AST transforms</i></b>. The slides are available at <a href="http://www.slideshare.net/MarcinGrzejszczak/introduction-to-groovy-runtime-metaprogramming-and-ast-transforms">SlideShare</a>&nbsp;and the code is available at <a href="https://bitbucket.org/gregorin1987/too-much-coding/src/e5ab7c69ab7b2796075fd6f087fbf31346aa2d2b/Groovy/ast/?at=default">TooMuchCoding Bitbucket</a>&nbsp;and <a href="https://github.com/marcingrzejszczak/too-much-coding/tree/master/Groovy/ast">TooMuchCoding Github</a> repositories. If you have any problems with reading any part of the slides or sth just post a comment here and I'll tr to help you :)<br /><br />Enjoy!<br /><br /><br /><a name='more'></a>
<!--more-->
<br /><iframe allowfullscreen="" frameborder="0" height="356" marginheight="0" marginwidth="0" scrolling="no" src="http://www.slideshare.net/slideshow/embed_code/30820561" style="border-width: 1px 1px 0; border: 1px solid #CCC; margin-bottom: 5px; max-width: 100%;" width="427"> </iframe> <br /><div style="margin-bottom: 5px;"><strong> <a href="https://www.slideshare.net/MarcinGrzejszczak/introduction-to-groovy-runtime-metaprogramming-and-ast-transforms" target="_blank" title="Introduction to Groovy runtime metaprogramming and AST transforms">Introduction to Groovy runtime metaprogramming and AST transforms</a> </strong> from <strong><a href="http://www.slideshare.net/MarcinGrzejszczak" target="_blank">Marcin Grzejszczak</a></strong> <br /><br />I had a discussion with one of the readers regarding issues related to creating an AST transformation that would be used on classes (and not on scripts). Often you can see that such a transformation does not work for you even though it should. The problem might be that you have the AST transformation compiled in the same time toghether with the class that you annotated with AST transformation related annotation.<br /><br />What you have to remember about is that your AST transformation related classes have to be compiled prior to using (that's why you can often find that your AST transformation is working when you right click on your annotated class in your IDE (or Groovy console) and manually compile that particular class. That's because you compile that particular class when other classes have already been compiled. That's the very same scenario as with compiling a script that is using an AST transformation - first your tranformations are compiled and afterwards at runtime the script gets compiled.<br /><br />Please check the additional repository <a href="https://github.com/marcingrzejszczak/ast_examples">ast_examples</a> that consists of the same examples as in the <a href="https://github.com/marcingrzejszczak/too-much-coding">TooMuchCoding </a>repository together with an additional AST transformation that is set on a class.</div></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Review of the Instant Mock Testing with PowerMock]]></title>
    <link href="http://toomuchcoding.com/blog/2013/12/16/review-of-instant-mock-testing-with/"/>
    <updated>2013-12-16T23:47:00+01:00</updated>
    <id>http://toomuchcoding.com/blog/2013/12/16/review-of-instant-mock-testing-with</id>
    <content type="html"><![CDATA[<div class='post'>
Hi!<br /><br />Quite recently I was asked by Packt publishing to write a review of the book <a href="http://bit.ly/181GmFv">Instant Mock Testing with PowerMock</a> by&nbsp;Deep Shah. I have just managed to go through it and would like to share my thoughts :)<br /><br /><a name='more'></a>
<!--more-->
<h2>The layout</h2><br />I enjoyed the book's layout with clear separation of the discussed issues with level of expertise required for the given section. What was also really nice was the precise division of content into the introductory part and the concrete solution to the problem.<br /><h2>What I liked</h2><br /><ul><li>PowerMock is a very powerful tool that allows to test legacy code that was very badly written. On the other hand it can be tempting not to refactor existing code or even write bad code from the very beginning. So after this long introduction what I liked was that the author emphasised at the beginning of some chapters how a proper design should look like and that PowerMock breaks the rule</li><li>Names of test methods in the shown examples - they are very clear and teach good practices</li><li>Important parts of code are shown in bold - it attracts the reader and makes him focus immediately on the crucial elements</li><li>The examples clearly present the solution to the given problem</li><li>That I could learn about the PowerMock's <i>suppress</i> functionality :)</li><li>I had all the important PowerMock features in one place written in a concise and readable manner</li><li>Very thorough explanations for beginners in terms of adding PowerMock to Eclipse or IntelliJ</li><li>Introductory sections of each recipie (for example introducing the Active Record pattern)</li></ul><h2>What I didn't like</h2><div><ul><li>It's a very subjective opinion but I definitely prefer creating assertions through <span style="font-family: Courier New, Courier, monospace;">assertThat</span> methods with proper matchers instead of using <span style="font-family: Courier New, Courier, monospace;">assertEquals</span>, <span style="font-family: Courier New, Courier, monospace;">assertNull</span> etc.</li><li>Not sure if that many javadocs were needed in the examples - for me they blur the image</li><li>On one hand the tests seem clean but on the other there are test scenarios in which the implementation is being tested instead of behaviour (for example in stubbing/verifying private methods or in partial mocking with spies). Of course I understand that sometimes it's done if we really care about some method execution or for the sake of showing PowerMock capabilities but in some cases&nbsp;(e.g. Partial mocking with spies)&nbsp;the refactoring process is not clear to me.</li></ul><h2>Summary</h2></div><div>I really enjoyed the book&nbsp;<a href="http://www.packtpub.com/mock-testing-with-powermock/book">Instant Mock Testing with PowerMock</a>&nbsp;by&nbsp;Deep Shah because I like books related to computer science :) I'm pretty sure that someone that reads it will know about all the important PowerMock's features - Deep Shah did a good job here. I would however recommend that one reads the PowerMock's documentation first, especially the <a href="https://code.google.com/p/powermock/wiki/Motivation">when to use it part</a>&nbsp;since as authors state it:</div><blockquote class="tr_bq"><span style="background-color: white; font-family: arial, sans-serif; font-size: 13px; line-height: 16.390625px;">... PowerMock is mainly intended for people with expert knowledge in unit testing. Putting it in the hands of junior developers may cause more harm than good.</span></blockquote><div>Also there is good tutorial&nbsp;<a href="http://www.jayway.com/2013/03/05/beyond-mocking-with-powermock/">recommended by the PowerMock's authors</a>&nbsp;and if you are a Mockito user you can profit from the <a href="https://code.google.com/p/powermock/wiki/MockitoUsage13">Mockito usage at the project's wiki</a>&nbsp;(although the examples there are not that specific as in Deep Shah's book).</div><div><br /></div></div>
]]></content>
  </entry>
  
</feed>
